<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Market | African Deals Domain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <link rel="preload" href="https://cdn.tailwindcss.com" as="script" onload="this.onload=null;this.rel='script'">
  <noscript><script src="https://cdn.tailwindcss.com"></script></noscript>
  <link rel="icon" href="/public/images/logo.png">
  <script>
    // Load non-critical CSS after page load for better performance
    window.addEventListener('load', function() {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/shared/styles.css';
      document.head.appendChild(link);
    });
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/shared/auth-utils.js"></script>
  <script src="/grocery/missing-functions.js"></script>
  <script src="/grocery/local-market-referrals.js"></script>
  <script src="/grocery/local-market-product-modal.js"></script>
  <script src="/grocery/local-market-core.js"></script>
  
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .menu-item-enter { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .sticky-cart { position: sticky; top: 6rem; }
    #map-preview { height: 200px; }
    .product-card { transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    
    /* Enhanced slider styling */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #10B981 0%, #10B981 10%, #E5E7EB 10%, #E5E7EB 100%);
      outline: none;
      border-radius: 15px;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10B981;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #10B981;
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-green-50">

  <!-- Header -->
  <header class="glass shadow-lg sticky top-0 z-40">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <!-- Logo & Mode Indicator -->
        <div class="flex items-center gap-4">
          <a href="/buyer/buyers-home.html" class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-12 w-12 rounded-xl shadow-lg" />
          </a>
          <div>
            <h1 class="font-bold text-lg text-green-700">üõí Local Market</h1>
            <p class="text-xs text-gray-500">Fresh ‚Ä¢ Fast ‚Ä¢ Local</p>
          </div>
        </div>

        <!-- Search Bar (Mobile Hidden) -->
        <div class="hidden lg:flex flex-1 max-w-lg mx-8">
          <div class="relative w-full">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="header-search" placeholder="Search products, categories..." 
                   class="w-full pl-12 pr-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
        </div>

        <!-- Navigation & User Actions -->
        <div class="flex items-center gap-2 md:gap-4">
          <!-- Location Indicator -->
          <div id="location-indicator" class="flex items-center gap-2 bg-green-100 text-green-700 px-3 py-2 rounded-xl text-sm font-medium cursor-pointer hover:bg-green-200 transition-colors" onclick="openLocationSettings()">
            <i class="fas fa-map-marker-alt text-green-600"></i>
            <span id="current-location" class="hidden sm:inline">Set Location</span>
            <span id="current-location-mobile" class="sm:hidden">üìç</span>
            <i class="fas fa-cog text-xs"></i>
          </div>
          
          <button onclick="switchToPhysicalProducts()" class="hidden md:flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-xl font-medium transition-all duration-300 shadow-lg text-sm">
            <i class="fas fa-box-open"></i>
            <span>Physical Products</span>
          </button>
          
          <!-- Order Tracking Button -->
          <button onclick="showMyOrders()" class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-xl font-medium transition-all duration-300 shadow-lg text-sm">
            <i class="fas fa-truck"></i>
            <span class="hidden sm:inline">Track Orders</span>
            <span class="sm:hidden">üöö</span>
          </button>
          
          <!-- User Menu -->
          <div class="relative">
            <button id="user-menu-btn" class="flex items-center gap-2 text-gray-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors" onclick="toggleUserMenu()">
              <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-green-600 text-sm"></i>
              </div>
              <span id="user-name" class="hidden md:block font-medium">Loading...</span>
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 hidden z-50">
              <div class="py-2">
                <button onclick="showMyOrders()" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left">
                  <i class="fas fa-receipt text-green-600"></i>
                  <span>My Orders</span>
                </button>
                <button onclick="showProfile()" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left">
                  <i class="fas fa-user text-green-600"></i>
                  <span>Profile</span>
                </button>
                <button onclick="openLocationSettings()" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left">
                  <i class="fas fa-map-marker-alt text-green-600"></i>
                  <span>Location Settings</span>
                </button>
                <button onclick="showHelpSupport()" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left">
                  <i class="fas fa-headset text-green-600"></i>
                  <span>Help & Support</span>
                </button>
                <hr class="my-2">
                <button id="logout-btn" class="flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors w-full text-left" onclick="logout()">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- FREE Delivery Promotion Banner -->
  <div class="bg-gradient-to-r from-green-500 via-blue-500 to-purple-600 text-white py-4 px-4 shadow-lg">
    <div class="max-w-8xl mx-auto">
      <div class="flex items-center justify-center gap-4 text-center">
        <div class="flex items-center gap-2">
          <i class="fas fa-truck text-2xl animate-bounce"></i>
          <span class="text-lg font-bold">üéâ FREE DELIVERY</span>
        </div>
        <div class="hidden md:block w-px h-8 bg-white/30"></div>
        <div class="flex items-center gap-2">
          <i class="fas fa-gift text-xl"></i>
          <span class="font-semibold">üì¶ FREE PACKAGING</span>
        </div>
        <div class="hidden md:block w-px h-8 bg-white/30"></div>
        <div class="flex items-center gap-2">
          <i class="fas fa-star text-xl"></i>
          <span class="font-semibold">‚ú® NO HIDDEN FEES</span>
        </div>
        <div class="hidden lg:block w-px h-8 bg-white/30"></div>
        <div class="hidden lg:flex items-center gap-2">
          <i class="fas fa-heart text-xl text-red-300"></i>
          <span class="font-semibold">What you see is what you pay!</span>
        </div>
      </div>
    </div>
  </div>

  <main class="max-w-8xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- Left Column: Filters and Products -->
    <div class="lg:col-span-3 space-y-8">
      
      <!-- Location & Search/Filter Panel -->
      <section class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          <!-- Location Info -->
          <div>
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-map-marker-alt text-xl text-green-600"></i>
              </div>
              <div>
                <h2 class="text-xl font-bold text-gray-800">Delivery Zone</h2>
                <p id="location-indicator" class="text-sm text-gray-600">
                  <i class="fas fa-spinner loading-spinner mr-1"></i>
                  Detecting your location...
                </p>
              </div>
            </div>
            <div id="map-preview" class="rounded-xl border border-gray-200 bg-gray-100 relative overflow-hidden hidden">
              <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
                <div class="text-center">
                  <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2"></i>
                  <p class="text-sm text-gray-500">Loading map...</p>
                </div>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button id="update-location-btn" class="flex-1 bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors" onclick="updateLocation()">
                <i class="fas fa-location-crosshairs mr-2"></i>Update Location
              </button>
              <button id="use-current-location-btn" class="bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors" onclick="getCurrentLocation()">
                <i class="fas fa-crosshairs"></i>
              </button>
            </div>
          </div>

          <!-- Search & Filters -->
          <div>
            <!-- Mobile Search (shown on mobile) -->
            <div class="lg:hidden relative mb-4">
              <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="text" id="mobile-search-bar" placeholder="Type to search products (min 2 chars)" onkeyup="handleProductSearch(this.value)" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500">
            </div>

            <!-- Filters -->
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                  <select id="category-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">All Categories</option>
                    <!-- Categories will be loaded dynamically -->
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                  <select id="sort-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="name">Name (A-Z)</option>
                    <option value="price_low">Price (Low to High)</option>
                    <option value="price_high">Price (High to Low)</option>
                    <option value="rating">Highest Rated</option>
                    <option value="newest">Newest First</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
                <div class="px-2">
                  <input type="range" id="price-range" min="0" max="10000" value="10000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                  <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0 RWF</span>
                    <span id="price-range-value">10,000 RWF</span>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
                  <select id="availability-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">All Products</option>
                    <option value="in_stock">In Stock Only</option>
                    <option value="low_stock">Low Stock</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Delivery</label>
                  <select id="delivery-time-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">Any Time</option>
                    <option value="fast">Under 1 hour</option>
                    <option value="standard">1-2 hours</option>
                    <option value="scheduled">Scheduled</option>
                  </select>
                </div>
              </div>

              <button id="clear-filters-btn" class="w-full bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors" onclick="clearAllFilters()">
                <i class="fas fa-times mr-2"></i>Clear All Filters
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Product Listings -->
      <section>
        <!-- Section Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Available Products</h2>
            <p id="products-count" class="text-sm text-gray-600">Loading products...</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="grid-view-btn" class="p-2 bg-green-100 text-green-600 rounded-lg" onclick="showNotification('Feature in development', 'info')">
              <i class="fas fa-th-large"></i>
            </button>
            <button id="list-view-btn" class="p-2 text-gray-400 hover:bg-gray-100 rounded-lg" onclick="showNotification('Feature in development', 'info')">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="products-loading" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- Loading skeletons -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden animate-pulse">
            <div class="h-48 bg-gray-200"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 bg-gray-200 rounded w-3/4"></div>
              <div class="h-3 bg-gray-200 rounded w-1/2"></div>
              <div class="h-6 bg-gray-200 rounded w-1/4"></div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden animate-pulse">
            <div class="h-48 bg-gray-200"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 bg-gray-200 rounded w-3/4"></div>
              <div class="h-3 bg-gray-200 rounded w-1/2"></div>
              <div class="h-6 bg-gray-200 rounded w-1/4"></div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden animate-pulse">
            <div class="h-48 bg-gray-200"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 bg-gray-200 rounded w-3/4"></div>
              <div class="h-3 bg-gray-200 rounded w-1/2"></div>
              <div class="h-6 bg-gray-200 rounded w-1/4"></div>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div id="product-listings" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 hidden">
          <!-- Product cards will be injected here by JS -->
        </div>

        <!-- No Products State -->
        <div id="no-products" class="text-center py-12 hidden">
          <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-shopping-basket text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No Products Found</h3>
          <p class="text-gray-500 mb-4">Try adjusting your filters or search terms</p>
          <button id="reset-search-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors" onclick="showNotification('Feature in development', 'info')">
            Reset Search
          </button>
        </div>

        <!-- Load More Button -->
        <div id="load-more-container" class="text-center mt-8 hidden">
          <button id="load-more-btn" class="bg-white border border-gray-300 text-gray-700 px-8 py-3 rounded-xl hover:bg-gray-50 transition-colors font-medium" onclick="loadMoreProducts()">
            <i class="fas fa-plus mr-2"></i>Load More Products
          </button>
        </div>
      </section>
    </div>

    <!-- Right Column: Shopping Menu -->
    <aside class="lg:col-span-1">
      <div class="sticky-cart">
        <div id="shopping-menu" class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
          <!-- Title -->
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800">Shopping Menu</h2>
            <span id="menu-item-count" class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
          </div>

          <!-- Item List -->
          <div id="menu-items-list" class="space-y-4 max-h-64 overflow-y-auto pr-2">
            <p class="text-center text-gray-500 py-8">Your menu is empty. Add items to get started!</p>
          </div>

          <!-- Cost Breakdown -->
          <div id="cost-breakdown" class="border-t border-gray-200 pt-4 space-y-2 text-sm hidden">
            <div class="flex justify-between">
              <span class="text-gray-600">Products Total</span>
              <span id="products-total">0 RWF</span>
            </div>
            <div class="flex justify-between">
              <span class="text-green-600">üéâ Platform Fee</span>
              <span id="platform-fee" class="text-green-600 font-semibold">FREE</span>
            </div>
            <div class="flex justify-between">
              <span class="text-green-600">üì¶ Packaging Fee</span>
              <span id="packaging-fee" class="text-green-600 font-semibold">FREE</span>
            </div>
            <div class="flex justify-between">
              <span class="text-green-600">üöö Delivery Fee</span>
              <span id="delivery-fee" class="text-green-600 font-semibold">FREE</span>
            </div>
            <div class="flex justify-between font-bold text-lg text-gray-800 border-t border-gray-200 pt-2 mt-2">
              <span>Grand Total</span>
              <span id="grand-total">1700 RWF</span>
            </div>
          </div>

          <!-- Delivery Info Setup -->
          <div id="delivery-info-setup" class="border-t border-gray-200 pt-4 space-y-3 hidden">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Time Window</label>
              <select class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                <option>ASAP (30-60 min)</option>
                <option>In 1-2 hours</option>
                <option>In 2-4 hours</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Note (Optional)</label>
              <textarea rows="2" placeholder="e.g., Call upon arrival" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></textarea>
            </div>
          </div>

          <!-- Checkout Button -->
          <button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled onclick="secureCheckout()">
            <i class="fas fa-shopping-cart mr-2"></i>Confirm & Checkout
          </button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Post-Order Confirmation Modal -->
  <div id="order-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center fade-in">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check-circle text-5xl text-green-500"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-3">Order Placed Successfully!</h2>
      <p class="text-gray-600 mb-6">Your fresh groceries are on the way. You can track the delivery in real-time.</p>
      
      <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
        <h3 class="font-semibold text-gray-700 mb-3">Order Summary</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Order Number:</span>
            <span class="font-mono">#LM-12345</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Estimated Delivery:</span>
            <span class="font-semibold text-green-600">35-50 minutes</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Assigned Agent:</span>
            <div class="flex items-center gap-2">
              <img src="/public/images/logo.png" alt="Agent" class="w-6 h-6 rounded-full">
              <span class="font-semibold">John D.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-4">
        <a href="/buyer/track-order.html?id=12345" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          <i class="fas fa-map-location-dot mr-2"></i>Track Delivery
        </a>
        <a href="/buyer/orders.html" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-colors">
          View Full Order Details
        </a>
      </div>
      <button id="close-modal-btn" class="mt-6 text-sm text-gray-500 hover:underline" onclick="showNotification('Feature in development', 'info')">Close</button>
    </div>
  </div>

  <script>
    // Simple initialization script - main functionality is in external files
    // Debug mode - set to true for detailed logging
    const DEBUG_MODE = window.location.search.includes('debug=true');
    
    function debugLog(message, data = null) {
      if (DEBUG_MODE) {
        console.log(`[LOCAL-MARKET-DEBUG] ${message}`, data || '');
      }
    }

    // Global error handler
    window.addEventListener('error', function(event) {
      console.error('Global error caught:', event.error);
      debugLog('Global error', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
      });
      
      // Show user-friendly error message
      if (event.error && event.error.message) {
        if (event.error.message.includes('is not defined')) {
          const functionName = event.error.message.match(/(\w+) is not defined/)?.[1];
          if (functionName) {
            showNotification(`Function "${functionName}" is missing. Please refresh the page.`, 'error');
          }
        } else {
          showNotification('An unexpected error occurred. Please refresh the page.', 'error');
        }
      }
    });

    // Global unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      debugLog('Unhandled promise rejection', { reason: event.reason });
      showNotification('A network or processing error occurred. Please try again.', 'error');
    });
    
    // Simple page initialization - main functionality is in external JS files
    debugLog('Local Market page loaded - external scripts will handle initialization');
  </script>
</body>
</html>
          if (data && data.success && data.user) {
            user = data.user;
          } else if (data && data.name) {
            // Direct user object
            user = data;
          } else if (data && data.data && data.data.name) {
            // Nested data object
            user = data.data;
          }
          
          if (user && user.name) {
            document.getElementById('user-name').textContent = user.name || 'User';
            if (user.latitude && user.longitude) {
              userLocation = { lat: user.latitude, lng: user.longitude };
              updateLocationDisplay();
            }
            debugLog('User info loaded successfully', user);
          } else {
            console.error('Failed to load user info:', data ? (data.error || data.message || 'Invalid response format') : 'No data received');
            // Fallback to localStorage user data
            const userData = localStorage.getItem('userData');
            if (userData) {
              try {
                const user = JSON.parse(userData);
                document.getElementById('user-name').textContent = user.name || 'User';
                debugLog('Using fallback user data from localStorage', user);
              } catch (parseError) {
                console.error('Error parsing fallback user data:', parseError);
                document.getElementById('user-name').textContent = 'User';
              }
            }
          }
        } catch (error) {
          console.error('Error loading user info:', error);
          if (error.message === 'Authentication failed') {
            return; // Already handled by makeAuthenticatedRequest
          }
          
          // Fallback to localStorage user data
          const userData = localStorage.getItem('userData');
          if (userData) {
            try {
              const user = JSON.parse(userData);
              document.getElementById('user-name').textContent = user.name || 'User';
              debugLog('Using fallback user data after error', user);
            } catch (parseError) {
              console.error('Error parsing fallback user data:', parseError);
              document.getElementById('user-name').textContent = 'User';
            }
          }
        }
      }

      function loadCategories() {
        fetch('/api/grocery/categories', {
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const categorySelect = document.getElementById('category-filter');
            data.categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category.name.toLowerCase();
              option.textContent = category.name;
              categorySelect.appendChild(option);
            });
          }
        })
        .catch(error => console.error('Error loading categories:', error));
      }

      function loadProducts() {
        console.log('[DEBUG] loadProducts() called');
        showProductsLoading(true);
        
        // Get user location for nearby products
        const savedLocation = getSavedLocation();
        console.log('[DEBUG] savedLocation:', savedLocation);
        let apiUrl = '/api/grocery/products';
        let queryParams = new URLSearchParams();
        
        if (savedLocation && savedLocation.lat && savedLocation.lng) {
          queryParams.append('lat', savedLocation.lat);
          queryParams.append('lng', savedLocation.lng);
          queryParams.append('radius', savedLocation.maxDistance || 10);
        }
        
        // Add default parameters
        queryParams.append('limit', '50');
        queryParams.append('page', '1');
        
        const fullUrl = apiUrl + '?' + queryParams.toString();
        
        fetch(fullUrl, {
          headers: getAuthToken() ? { 'Authorization': `Bearer ${getAuthToken()}` } : {}
        })
        .then(response => response.json())
        .then(data => {
          console.log('[DEBUG] API response received:', data);
          showProductsLoading(false);
          if (data.success) {
            console.log('[DEBUG] API success, raw products:', data.products?.length || 0);
            console.log('[DEBUG] Sample product data:', data.products?.[0]);
            console.log('[DEBUG] Sample product data:', data.products?.[0]);
            // Filter to only show products that are in stock and map API fields
            allProducts = (data.products || []).filter(product => {
              const stock = parseInt(product.available_stock) || parseInt(product.stock_quantity) || parseInt(product.stock) || 0;
              return stock > 0;
            }).map(product => ({
              id: product.id,
              product_id: product.product_id,
              name: product.product_name,
              product_name: product.product_name,
              description: product.product_description || product.description,
              price: product.unit_price,
              unit_price: product.unit_price,
              price_per_unit: product.unit_price,
              unit_type: product.unit_type,
              stock_quantity: product.available_stock,
              available_stock: product.available_stock,
              main_image: product.main_image,
              seller_name: product.seller_name,
              seller_id: product.seller_id,
              location: product.seller_location || product.seller_city,
              seller_location: product.seller_location || product.seller_city,
              category: product.category_name,
              distance: product.distance_km || 0,
              latitude: product.lat,
              longitude: product.lng
            }));
            console.log('[DEBUG] Filtered products (in stock):', allProducts.length);
            filteredProducts = allProducts;
            console.log('[DEBUG] About to call renderProducts()');
            renderProducts();
            updateProductsCount();
            
            // Show location-based message
            if (savedLocation && data.products) {
              showLocationBasedMessage(data.products.length, savedLocation.maxDistance || 10);
            }
          } else {
            console.log('[DEBUG] API failed, calling showNoProducts()');
            showNoProducts();
          }
        })
        .catch(error => {
          showProductsLoading(false);
          console.error('[DEBUG] Error loading products:', error);
          
          // Always try fallback first, then sample products
          console.log('[DEBUG] Calling loadProductsFallback()');
          loadProductsFallback();
        });
      }
      
      function loadProductsFallback() {
        fetch('/api/grocery/products', {
          headers: getAuthToken() ? { 'Authorization': `Bearer ${getAuthToken()}` } : {}
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('[DEBUG] Fallback API success, raw products:', data.products?.length || 0);
            // Filter to only show products that are in stock and map API fields
            allProducts = (data.products || []).filter(product => {
              const stock = parseInt(product.available_stock) || parseInt(product.stock_quantity) || parseInt(product.stock) || 0;
              return stock > 0;
            }).map(product => ({
              id: product.id,
              product_id: product.product_id,
              name: product.product_name,
              product_name: product.product_name,
              description: product.product_description || product.description,
              price: product.unit_price,
              unit_price: product.unit_price,
              price_per_unit: product.unit_price,
              unit_type: product.unit_type,
              stock_quantity: product.available_stock,
              available_stock: product.available_stock,
              main_image: product.main_image,
              seller_name: product.seller_name,
              seller_id: product.seller_id,
              location: product.seller_location || product.seller_city,
              seller_location: product.seller_location || product.seller_city,
              category: product.category_name,
              distance: product.distance_km || 0,
              latitude: product.lat,
              longitude: product.lng
            }));
            console.log('[DEBUG] Fallback filtered products:', allProducts.length);
            filteredProducts = allProducts;
            renderProducts();
            updateProductsCount();
            showNotification('Showing all products (location not set)', 'info');
          } else {
            console.log('[DEBUG] Fallback API failed, loading sample products');
            loadSampleProducts();
          }
        })
        .catch(error => {
          console.error('Error loading fallback products:', error);
          loadSampleProducts();
        });
      }

      function loadSampleProducts() {
        console.log('[LOCAL-MARKET] Loading sample products for testing');
        
        // Realistic sample products from real sellers with available stock
        const sampleProducts = [
          {
            id: 'kgl-001',
            product_name: 'Fresh Red Tomatoes',
            description: 'Premium quality red tomatoes, locally grown in Musanze. Perfect for cooking, salads, and sauces. Rich in vitamins and antioxidants.',
            price_per_unit: 450,
            unit_type: 'kg',
            stock_quantity: 35,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Musanze Fresh Farms',
            seller_id: 'seller-001',
            location: 'Musanze District, Northern Province',
            category: 'Vegetables',
            latitude: -1.4983,
            longitude: 29.6356,
            distance: 2.1
          },
          {
            id: 'kgl-002',
            product_name: 'Sweet Bananas',
            description: 'Sweet and ripe bananas from Nyagatare farms. High in potassium and natural sugars. Perfect for breakfast or snacks.',
            price_per_unit: 750,
            unit_type: 'bunch',
            stock_quantity: 22,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Nyagatare Banana Cooperative',
            seller_id: 'seller-002',
            location: 'Nyagatare District, Eastern Province',
            category: 'Fruits',
            latitude: -1.2944,
            longitude: 30.3378,
            distance: 1.8
          },
          {
            id: 'kgl-003',
            product_name: 'Fresh Cow Milk',
            description: 'Pure, pasteurized fresh milk from grass-fed cows in Nyabihu. Rich in calcium and protein. Delivered daily.',
            price_per_unit: 1100,
            unit_type: 'liter',
            stock_quantity: 18,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Nyabihu Dairy Cooperative',
            seller_id: 'seller-003',
            location: 'Nyabihu District, Western Province',
            category: 'Dairy',
            latitude: -1.6667,
            longitude: 29.5167,
            distance: 3.4
          },
          {
            id: 'kgl-004',
            product_name: 'Whole Wheat Bread',
            description: 'Freshly baked whole wheat bread made with organic flour. No preservatives added. Baked daily in our local bakery.',
            price_per_unit: 550,
            unit_type: 'loaf',
            stock_quantity: 28,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Kigali Artisan Bakery',
            seller_id: 'seller-004',
            location: 'Gasabo District, Kigali City',
            category: 'Bakery',
            latitude: -1.9706,
            longitude: 30.1044,
            distance: 0.8
          },
          {
            id: 'kgl-005',
            product_name: 'Farm Fresh Eggs',
            description: 'Free-range chicken eggs from Rwamagana farms. High in protein and omega-3. Collected daily from happy, healthy chickens.',
            price_per_unit: 250,
            unit_type: 'piece',
            stock_quantity: 45,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Rwamagana Poultry Farm',
            seller_id: 'seller-005',
            location: 'Rwamagana District, Eastern Province',
            category: 'Poultry',
            latitude: -1.9444,
            longitude: 30.4347,
            distance: 2.9
          },
          {
            id: 'kgl-006',
            product_name: 'Irish Potatoes',
            description: 'High-quality Irish potatoes from Musanze highlands. Perfect for cooking, frying, or mashing. Rich in carbohydrates and vitamins.',
            price_per_unit: 350,
            unit_type: 'kg',
            stock_quantity: 50,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Highland Potato Growers',
            seller_id: 'seller-006',
            location: 'Musanze District, Northern Province',
            category: 'Vegetables',
            latitude: -1.4983,
            longitude: 29.6356,
            distance: 2.1
          },
          {
            id: 'kgl-007',
            product_name: 'Fresh Avocados',
            description: 'Creamy, ripe avocados from Huye district. Rich in healthy fats and vitamins. Perfect for salads, sandwiches, or smoothies.',
            price_per_unit: 200,
            unit_type: 'piece',
            stock_quantity: 32,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Huye Fruit Gardens',
            seller_id: 'seller-007',
            location: 'Huye District, Southern Province',
            category: 'Fruits',
            latitude: -2.5950,
            longitude: 29.7392,
            distance: 4.2
          },
          {
            id: 'kgl-008',
            product_name: 'White Rice',
            description: 'Premium quality white rice from Nyagatare. Well-cleaned and processed. Perfect for daily meals and special occasions.',
            price_per_unit: 1800,
            unit_type: 'kg',
            stock_quantity: 25,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Nyagatare Rice Millers',
            seller_id: 'seller-008',
            location: 'Nyagatare District, Eastern Province',
            category: 'Grains',
            latitude: -1.2944,
            longitude: 30.3378,
            distance: 1.8
          },
          {
            id: 'kgl-009',
            product_name: 'Fresh Carrots',
            description: 'Crunchy, sweet carrots from Ruhango farms. High in beta-carotene and fiber. Great for cooking, salads, or juicing.',
            price_per_unit: 400,
            unit_type: 'kg',
            stock_quantity: 20,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Ruhango Vegetable Cooperative',
            seller_id: 'seller-009',
            location: 'Ruhango District, Southern Province',
            category: 'Vegetables',
            latitude: -2.0167,
            longitude: 29.7833,
            distance: 3.7
          },
          {
            id: 'kgl-010',
            product_name: 'Natural Honey',
            description: 'Pure, raw honey from Nyungwe forest beekeepers. Unprocessed and rich in natural enzymes. Perfect for tea, cooking, or health benefits.',
            price_per_unit: 3500,
            unit_type: 'bottle (500ml)',
            stock_quantity: 12,
            main_image: '/public/images/placeholder-product.jpg',
            seller_name: 'Nyungwe Beekeepers Association',
            seller_id: 'seller-010',
            location: 'Nyamagabe District, Southern Province',
            category: 'Natural Products',
            latitude: -2.4833,
            longitude: 29.1333,
            distance: 5.1
          }
        ];

        console.log('[DEBUG] Setting sample products:', sampleProducts.length);
        allProducts = sampleProducts;
        filteredProducts = allProducts;
        console.log('[DEBUG] About to call renderProducts() from loadSampleProducts');
        renderProducts();
        updateProductsCount();
        
        // Show notification that sample data is being used
        if (DEBUG_MODE) {
          showNotification('Using sample products for testing', 'info');
        } else {
          showNotification(`‚úÖ Found ${allProducts.length} fresh products from local sellers`, 'success');
        }
        
        debugLog('Sample products loaded', { count: sampleProducts.length });
      }
      
      function showLocationBasedMessage(productCount, maxDistance) {
        const message = `Found ${productCount} products within ${maxDistance}km of your location`;
        showNotification(message, 'success');
      }

      function renderProducts() {
        console.log('[DEBUG] renderProducts called');
        console.log('[DEBUG] filteredProducts length:', filteredProducts.length);
        console.log('[DEBUG] allProducts length:', allProducts.length);
        
        const productListings = document.getElementById('product-listings');
        const noProductsDiv = document.getElementById('no-products');
        const loadingDiv = document.getElementById('products-loading');
        
        if (!productListings) {
          console.error('[DEBUG] product-listings element not found!');
          return;
        }
        
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsToShow = filteredProducts.slice(startIndex, endIndex);

        console.log('[DEBUG] productsToShow length:', productsToShow.length);
        console.log('[DEBUG] currentPage:', currentPage, 'productsPerPage:', productsPerPage);

        if (productsToShow.length === 0) {
          console.log('[DEBUG] No products to show, calling showNoProducts()');
          showNoProducts();
          return;
        }

        console.log('[DEBUG] Showing products, removing hidden class');
        productListings.classList.remove('hidden');
        if (noProductsDiv) noProductsDiv.classList.add('hidden');
        if (loadingDiv) loadingDiv.classList.add('hidden');

        productListings.innerHTML = productsToShow.map(product => {
          // Ensure product has all required fields with fallbacks
          const safeProduct = {
            id: product.id || product.product_id || Math.random().toString(36).substr(2, 9),
            base_product_id: product.product_id || product.id || null, // base products table id for referrals
            product_name: product.name || product.product_name || 'Unknown Product',
            description: product.description || 'No description available',
            price_per_unit: parseFloat(product.unit_price) || parseFloat(product.price_per_unit) || parseFloat(product.price) || 0,
            unit_type: product.unit_type || product.unit || 'unit',
            stock_quantity: parseInt(product.stock_quantity) || parseInt(product.stock) || parseInt(product.quantity_available) || 0,
            main_image: product.main_image || product.image_url || product.image || '/public/images/placeholder-product.jpg',
            seller_name: product.seller_name || product.seller || 'Unknown Seller',
            seller_id: product.seller_id || product.user_id || 'unknown',
            location: product.location || product.seller_location || 'Location not specified',
            distance: parseFloat(product.distance) || 0,
            category: product.category_name || product.category || 'Uncategorized'
          };
          
          return `
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden product-card fade-in">
            <div class="relative">
              <img src="${safeProduct.main_image}" 
                   alt="${safeProduct.product_name}" class="w-full h-48 object-cover">
              <div class="absolute top-4 right-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${safeProduct.stock_quantity > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${safeProduct.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'}
                </span>
              </div>
              ${safeProduct.stock_quantity <= 10 && safeProduct.stock_quantity > 0 ? `
                <div class="absolute top-4 left-4">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                    Low Stock
                  </span>
                </div>
              ` : ''}
            </div>
            
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-2">${safeProduct.product_name}</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${safeProduct.description}</p>
              
              <div class="flex items-center justify-between mb-4">
                <div>
                  <span class="text-2xl font-bold text-green-600">${safeProduct.price_per_unit.toLocaleString()} RWF</span>
                  <span class="text-gray-500 text-sm">/ ${safeProduct.unit_type}</span>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Available</p>
                  <p class="font-semibold">${safeProduct.stock_quantity} ${safeProduct.unit_type}</p>
                </div>
              </div>
              
              <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span><i class="fas fa-tag mr-1"></i>${safeProduct.category}</span>
                <span><i class="fas fa-map-marker-alt mr-1"></i>${safeProduct.distance.toFixed(1)} km</span>
              </div>
              
              ${safeProduct.stock_quantity > 0 ? `
                <div class="flex items-center gap-2 mb-4">
                  <label class="text-sm font-medium">Qty:</label>
                  <input type="number" id="qty-${safeProduct.id}" value="1" min="1" max="${safeProduct.stock_quantity}" 
                         class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-green-500">
                  <span class="text-sm text-gray-600">${safeProduct.unit_type}</span>
                </div>
                <button onclick="addToMenu('${safeProduct.id}')" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition-colors shadow-lg">
                  <i class="fas fa-plus mr-2"></i>Add to Menu
                </button>
              ` : `
                <button disabled class="w-full bg-gray-400 text-white font-semibold py-3 rounded-xl cursor-not-allowed">
                  <i class="fas fa-times mr-2"></i>Out of Stock
                </button>
              `}
            </div>
          </div>
        `;
        }).join('');

        console.log('[DEBUG] Generated HTML length:', productListings.innerHTML.length);
        console.log('[DEBUG] First 200 chars of HTML:', productListings.innerHTML.substring(0, 200));

        // Update load more button
        updateLoadMoreButton();
      }

      // Utility functions
      function showProductsLoading(show) {
        const loadingDiv = document.getElementById('products-loading');
        const productsDiv = document.getElementById('product-listings');
        const noProductsDiv = document.getElementById('no-products');
        
        console.log('[DEBUG] showProductsLoading called with:', show);
        
        if (show) {
          loadingDiv.classList.remove('hidden');
          productsDiv.classList.add('hidden');
          noProductsDiv.classList.add('hidden');
        } else {
          loadingDiv.classList.add('hidden');
          // Don't automatically show products here - let renderProducts() handle it
        }
      }

      function showNoProducts() {
        console.log('[DEBUG] showNoProducts() called');
        document.getElementById('products-loading').classList.add('hidden');
        document.getElementById('product-listings').classList.add('hidden');
        document.getElementById('no-products').classList.remove('hidden');
      }

      function updateProductsCount() {
        const count = filteredProducts.length;
        document.getElementById('products-count').textContent = `${count} products found`;
      }

      function updateLoadMoreButton() {
        const loadMoreContainer = document.getElementById('load-more-container');
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        
        if (currentPage < totalPages) {
          loadMoreContainer.classList.remove('hidden');
        } else {
          loadMoreContainer.classList.add('hidden');
        }
      }

      function calculateDistance(lat1, lng1) {
        const lat2 = userLocation.lat;
        const lng2 = userLocation.lng;
        
        const R = 6371; // Radius of the Earth in kilometers
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      function initializeMap() {
        // Maps are currently hidden, so skip initialization
        console.log('[LOCAL-MARKET] Map initialization skipped (maps are hidden)');
        return;
        
        // Initialize main map preview
        try {
          const mapElement = document.getElementById('map-preview');
          if (!mapElement || mapElement.classList.contains('hidden')) {
            console.log('[LOCAL-MARKET] Map element not found or hidden, skipping initialization');
            return;
          }
          
          const map = L.map('map-preview').setView([userLocation.lat, userLocation.lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([userLocation.lat, userLocation.lng]).addTo(map).bindPopup('Your location');
          
          // Hide loading indicator
          setTimeout(() => {
            const loadingElement = document.getElementById('map-loading');
            if (loadingElement) {
              loadingElement.classList.add('hidden');
            }
          }, 1000);
        } catch (error) {
          console.error('Error initializing main map:', error);
        }

        // Initialize floating map
        initializeFloatingMap();
      }

      function initializeFloatingMap() {
        // Skip floating map initialization since it's hidden
        console.log('[LOCAL-MARKET] Floating map initialization skipped (maps are hidden)');
        return;
        
        try {
          // Initialize floating map
          const floatingMap = L.map('floating-map').setView([userLocation.lat, userLocation.lng], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(floatingMap);
          
          // Add user location marker
          const userMarker = L.marker([userLocation.lat, userLocation.lng])
            .addTo(floatingMap)
            .bindPopup('Your current location');

          // Hide floating map loading indicator
          setTimeout(() => {
            const floatingLoadingElement = document.getElementById('floating-map-loading');
            if (floatingLoadingElement) {
              floatingLoadingElement.classList.add('hidden');
            }
          }, 1500);

          // Setup floating map controls
          setupFloatingMapControls(floatingMap);

          debugLog('Floating map initialized successfully');
        } catch (error) {
          console.error('Error initializing floating map:', error);
          // Hide loading indicator even on error
          setTimeout(() => {
            const floatingLoadingElement = document.getElementById('floating-map-loading');
            if (floatingLoadingElement) {
              floatingLoadingElement.innerHTML = `
                <div class="text-center">
                  <i class="fas fa-exclamation-triangle text-yellow-600 text-lg mb-2"></i>
                  <p class="text-xs text-gray-600">Map unavailable</p>
                </div>
              `;
            }
          }, 1000);
        }
      }

      function setupFloatingMapControls(map) {
        // Toggle map size
        document.getElementById('toggle-map-size').addEventListener('click', () => {
          const widget = document.getElementById('floating-map-widget');
          widget.classList.toggle('expanded');
          
          // Invalidate map size after transition
          setTimeout(() => {
            map.invalidateSize();
          }, 300);
        });

        // Minimize map
        document.getElementById('minimize-map').addEventListener('click', () => {
          const widget = document.getElementById('floating-map-widget');
          const minimizedBtn = document.getElementById('minimized-map-btn');
          
          widget.classList.add('minimized');
          minimizedBtn.classList.remove('hidden');
        });

        // Restore map from minimized state
        document.getElementById('minimized-map-btn').addEventListener('click', () => {
          const widget = document.getElementById('floating-map-widget');
          const minimizedBtn = document.getElementById('minimized-map-btn');
          
          widget.classList.remove('minimized');
          minimizedBtn.classList.add('hidden');
          
          // Invalidate map size after restoration
          setTimeout(() => {
            map.invalidateSize();
          }, 300);
        });
      }

      function updateLocationDisplay() {
        document.getElementById('location-indicator').innerHTML = `
          <i class="fas fa-map-marker-alt mr-1"></i>
          Showing products near your location
        `;
      }

      function setupEventListeners() {
        // Search functionality
        const searchInputs = ['header-search', 'mobile-search-bar'];
        searchInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener('input', debounce(handleSearch, 300));
          }
        });

        // Filter functionality
        document.getElementById('category-filter').addEventListener('change', applyFilters);
        document.getElementById('sort-filter').addEventListener('change', applyFilters);
        document.getElementById('availability-filter').addEventListener('change', applyFilters);
        document.getElementById('delivery-time-filter').addEventListener('change', applyFilters);
        document.getElementById('price-range').addEventListener('input', handlePriceRange);

        // Clear filters
        document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);

        // Load more products
        document.getElementById('load-more-btn').addEventListener('click', loadMoreProducts);

        // Reset search
        document.getElementById('reset-search-btn').addEventListener('click', resetSearch);

        // User menu - using onclick in HTML, no need for addEventListener
        // document.getElementById('user-menu-btn').addEventListener('click', toggleUserMenu);
        // document.getElementById('logout-btn').addEventListener('click', logout);

        // Location update
        document.getElementById('update-location-btn').addEventListener('click', updateLocation);
        document.getElementById('use-current-location-btn').addEventListener('click', getCurrentLocation);

        // Checkout - Remove duplicate event listener (already handled below)
        // document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
        // document.getElementById('close-modal-btn').addEventListener('click', closeOrderModal);
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function handleSearch(e) {
        const query = e.target.value.toLowerCase().trim();
        if (query === '') {
          filteredProducts = allProducts;
        } else {
          filteredProducts = allProducts.filter(product =>
            product.product_name.toLowerCase().includes(query) ||
            product.description.toLowerCase().includes(query) ||
            product.category.toLowerCase().includes(query)
          );
        }
        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function applyFilters() {
        const category = document.getElementById('category-filter').value;
        const sort = document.getElementById('sort-filter').value;
        const availability = document.getElementById('availability-filter').value;
        const deliveryTime = document.getElementById('delivery-time-filter').value;
        const maxPrice = parseInt(document.getElementById('price-range').value);

        filteredProducts = allProducts.filter(product => {
          if (category && product.category.toLowerCase() !== category) return false;
          if (availability === 'in_stock' && product.stock_quantity <= 0) return false;
          if (availability === 'low_stock' && product.stock_quantity > 10) return false;
          if (product.price_per_unit > maxPrice) return false;
          return true;
        });

        // Apply sorting
        if (sort === 'price_low') {
          filteredProducts.sort((a, b) => a.price_per_unit - b.price_per_unit);
        } else if (sort === 'price_high') {
          filteredProducts.sort((a, b) => b.price_per_unit - a.price_per_unit);
        } else if (sort === 'name') {
          filteredProducts.sort((a, b) => a.product_name.localeCompare(b.product_name));
        } else if (sort === 'newest') {
          filteredProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function handlePriceRange(e) {
        const value = e.target.value;
        document.getElementById('price-range-value').textContent = `${parseInt(value).toLocaleString()} RWF`;
        applyFilters();
      }

      function clearFilters() {
        document.getElementById('category-filter').value = '';
        document.getElementById('sort-filter').value = 'name';
        document.getElementById('availability-filter').value = '';
        document.getElementById('delivery-time-filter').value = '';
        document.getElementById('price-range').value = '10000';
        document.getElementById('price-range-value').textContent = '10,000 RWF';
        
        // Clear search inputs
        const searchInputs = ['header-search', 'mobile-search-bar'];
        searchInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) input.value = '';
        });

        filteredProducts = allProducts;
        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function loadMoreProducts() {
        currentPage++;
        renderProducts();
      }

      function resetSearch() {
        clearFilters();
      }

      function toggleUserMenu() {
        try {
          const dropdown = document.getElementById('user-dropdown');
          if (dropdown) {
            dropdown.classList.toggle('hidden');
            debugLog('User menu toggled');
          } else {
            console.error('User dropdown element not found');
          }
        } catch (error) {
          console.error('Error toggling user menu:', error);
          showNotification('Error opening user menu', 'error');
        }
      }

      // Missing user menu functions
      function showMyOrders() {
        try {
          debugLog('Opening My Orders page...');
          
          // Close the dropdown first
          const dropdown = document.getElementById('user-dropdown');
          if (dropdown) {
            dropdown.classList.add('hidden');
          }
          
          // Create and show orders modal
          showOrdersModal();
          
        } catch (error) {
          console.error('Error showing orders:', error);
          showNotification('Error loading orders', 'error');
        }
      }

      function showProfile() {
        try {
          debugLog('Opening Profile page...');
          
          // Close the dropdown first
          const dropdown = document.getElementById('user-dropdown');
          if (dropdown) {
            dropdown.classList.add('hidden');
          }
          
          // Create and show profile modal
          showProfileModal();
          
        } catch (error) {
          console.error('Error showing profile:', error);
          showNotification('Error loading profile', 'error');
        }
      }

      function showHelpSupport() {
        try {
          debugLog('Opening Help & Support page...');
          
          // Close the dropdown first
          const dropdown = document.getElementById('user-dropdown');
          if (dropdown) {
            dropdown.classList.add('hidden');
          }
          
          // Create and show help modal
          showHelpModal();
          
        } catch (error) {
          console.error('Error showing help:', error);
          showNotification('Error loading help', 'error');
        }
      }

      // Orders Modal
      function showOrdersModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h2 class="text-2xl font-bold text-gray-800">My Orders</h2>
              <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
              <div id="orders-content">
                <div class="text-center py-8">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
                  <p class="text-gray-600">Loading your orders...</p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        loadUserOrders();
      }

      // Profile Modal
      function showProfileModal() {
        const currentUser = getCurrentUser();
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h2 class="text-2xl font-bold text-gray-800">My Profile</h2>
              <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
              <div class="space-y-6">
                <div class="flex items-center space-x-4">
                  <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-green-600 text-2xl"></i>
                  </div>
                  <div>
                    <h3 class="text-xl font-semibold text-gray-800">${currentUser?.name || 'User'}</h3>
                    <p class="text-gray-600">${currentUser?.email || 'user@example.com'}</p>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-700 mb-2">Contact Information</h4>
                    <p class="text-sm text-gray-600">Phone: ${currentUser?.phone || 'Not provided'}</p>
                    <p class="text-sm text-gray-600">Email: ${currentUser?.email || 'Not provided'}</p>
                  </div>
                  
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-700 mb-2">Location</h4>
                    <p class="text-sm text-gray-600">${currentUser?.address || 'Location not set'}</p>
                    <button onclick="openLocationSettings()" class="text-green-600 text-sm hover:underline mt-2">Update Location</button>
                  </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                  <h4 class="font-semibold text-blue-700 mb-2">Account Statistics</h4>
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span class="text-blue-600">Total Orders:</span>
                      <span class="font-semibold ml-2">0</span>
                    </div>
                    <div>
                      <span class="text-blue-600">Member Since:</span>
                      <span class="font-semibold ml-2">${new Date().getFullYear()}</span>
                    </div>
                  </div>
                </div>
                
                <div class="flex space-x-4">
                  <button onclick="editProfile()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    Edit Profile
                  </button>
                  <button onclick="changePassword()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    Change Password
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      // Help Modal
      function showHelpModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h2 class="text-2xl font-bold text-gray-800">Help & Support</h2>
              <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
              <div class="space-y-6">
                <!-- Contact Information -->
                <div class="bg-green-50 p-6 rounded-lg">
                  <h3 class="text-lg font-semibold text-green-800 mb-4">üìû Contact African Deals</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <p class="text-sm text-green-700 mb-2">üì± Phone Support:</p>
                      <p class="font-semibold text-green-800">+250 785 636 999</p>
                      <button onclick="copyToClipboard('+250785636999')" class="text-green-600 text-sm hover:underline">Copy Number</button>
                    </div>
                    <div>
                      <p class="text-sm text-green-700 mb-2">‚úâÔ∏è Email Support:</p>
                      <p class="font-semibold text-green-800">support@africandeals.rw</p>
                      <button onclick="copyToClipboard('support@africandeals.rw')" class="text-green-600 text-sm hover:underline">Copy Email</button>
                    </div>
                  </div>
                </div>
                
                <!-- FAQ Section -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ùì Frequently Asked Questions</h3>
                  <div class="space-y-3">
                    <div class="border border-gray-200 rounded-lg p-4">
                      <h4 class="font-semibold text-gray-700 mb-2">How do I place an order?</h4>
                      <p class="text-sm text-gray-600">Browse products, add items to your cart, and proceed to checkout. You can pay via mobile money.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                      <h4 class="font-semibold text-gray-700 mb-2">What payment methods do you accept?</h4>
                      <p class="text-sm text-gray-600">We accept mobile money payments (MTN Mobile Money, Airtel Money) and cash on delivery.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                      <h4 class="font-semibold text-gray-700 mb-2">How long does delivery take?</h4>
                      <p class="text-sm text-gray-600">Local market deliveries typically take 30-60 minutes depending on your location and product availability.</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                      <h4 class="font-semibold text-gray-700 mb-2">Can I track my order?</h4>
                      <p class="text-sm text-gray-600">Yes! Use the "Track Orders" button to see real-time updates on your order status and delivery progress.</p>
                    </div>
                  </div>
                </div>
                
                <!-- Quick Actions -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">üöÄ Quick Actions</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showMyOrders()" class="bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition-colors text-left">
                      <i class="fas fa-receipt mb-2"></i>
                      <div class="font-semibold">View My Orders</div>
                      <div class="text-sm opacity-90">Check your order history</div>
                    </button>
                    <button onclick="openLocationSettings()" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition-colors text-left">
                      <i class="fas fa-map-marker-alt mb-2"></i>
                      <div class="font-semibold">Update Location</div>
                      <div class="text-sm opacity-90">Set your delivery address</div>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      // Helper functions for modals
      function closeModal(button) {
        try {
          const modal = button.closest('.fixed');
          if (modal) {
            modal.remove();
            debugLog('Modal closed');
          }
        } catch (error) {
          console.error('Error closing modal:', error);
        }
      }

      function copyToClipboard(text) {
        try {
          navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
          }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Copied to clipboard!', 'success');
          });
        } catch (error) {
          console.error('Error copying to clipboard:', error);
          showNotification('Failed to copy', 'error');
        }
      }

      function editProfile() {
        showNotification('Profile editing feature coming soon!', 'info');
      }

      function changePassword() {
        showNotification('Password change feature coming soon!', 'info');
      }

      // Load user orders from database
      async function loadUserOrders() {
        try {
          const ordersContent = document.getElementById('orders-content');
          if (!ordersContent) return;

          debugLog('Loading user orders from database...');

          // Fetch real orders from API
          const response = await makeAuthenticatedRequest('/api/local-market-orders/orders');
          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to fetch orders');
          }

          const orders = data.orders || [];
          debugLog('Loaded orders', { count: orders.length });

          if (orders.length === 0) {
            ordersContent.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-shopping-bag text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">No Orders Yet</h3>
                <p class="text-gray-500 mb-4">Start shopping to see your orders here!</p>
                <button onclick="closeModal(this)" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                  Start Shopping
                </button>
              </div>
            `;
          } else {
            ordersContent.innerHTML = `
              <div class="space-y-4">
                ${orders.map(order => {
                  const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'confirmed': 'bg-blue-100 text-blue-800',
                    'preparing': 'bg-purple-100 text-purple-800',
                    'ready_for_pickup': 'bg-orange-100 text-orange-800',
                    'out_for_delivery': 'bg-indigo-100 text-indigo-800',
                    'delivered': 'bg-green-100 text-green-800',
                    'completed': 'bg-green-200 text-green-900',
                    'cancelled': 'bg-red-100 text-red-800'
                  };
                  
                  const statusColor = statusColors[order.status] || 'bg-gray-100 text-gray-800';
                  const orderDate = new Date(order.created_at).toLocaleDateString();
                  const canConfirmDelivery = order.status === 'delivered' && !order.delivery_confirmed;
                  const canSubmitPayment = order.payment_status === 'pending';
                  
                  return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                      <div class="flex justify-between items-start mb-3">
                        <div>
                          <h4 class="font-semibold text-gray-800">Order #${order.id}</h4>
                          <p class="text-sm text-gray-600">${orderDate}</p>
                          <p class="text-xs text-gray-500">${order.product_names || 'Multiple items'}</p>
                        </div>
                        <div class="text-right">
                          <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                            ${order.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                          </span>
                          ${order.payment_status !== 'confirmed' ? `
                            <div class="mt-1">
                              <span class="px-2 py-1 rounded text-xs ${
                                order.payment_status === 'pending' ? 'bg-red-100 text-red-700' :
                                order.payment_status === 'submitted' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-green-100 text-green-700'
                              }">
                                Payment: ${order.payment_status}
                              </span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                      
                      <div class="flex justify-between items-center mb-3">
                        <p class="text-sm text-gray-600">${order.item_count || 0} items</p>
                        <p class="font-semibold text-gray-800">${parseFloat(order.grand_total || 0).toLocaleString()} RWF</p>
                      </div>
                      
                      <div class="flex space-x-2">
                        <button onclick="viewOrderDetails('${order.id}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                          <i class="fas fa-eye mr-1"></i>View Details
                        </button>
                        
                        ${canSubmitPayment ? `
                          <button onclick="submitPaymentProof('${order.id}')" class="flex-1 bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 transition-colors">
                            <i class="fas fa-receipt mr-1"></i>Submit Payment
                          </button>
                        ` : ''}
                        
                        ${canConfirmDelivery ? `
                          <button onclick="confirmDelivery('${order.id}')" class="flex-1 bg-purple-500 text-white px-3 py-2 rounded text-sm hover:bg-purple-600 transition-colors">
                            <i class="fas fa-check mr-1"></i>Confirm Delivery
                          </button>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading orders:', error);
          const ordersContent = document.getElementById('orders-content');
          if (ordersContent) {
            ordersContent.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-300 text-6xl mb-4"></i>
                <h3 class="text-lg font-semibold text-red-600 mb-2">Error Loading Orders</h3>
                <p class="text-gray-500 mb-4">Please try again later or contact support.</p>
                <button onclick="loadUserOrders()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                  Retry
                </button>
              </div>
            `;
          }
        }
      }

      // Additional missing functions
      function switchToPhysicalProducts() {
        try {
          debugLog('Switching to physical products...');
          showNotification('Redirecting to Physical Products...', 'info');
          setTimeout(() => {
            window.location.href = '/buyer/physical-products.html';
          }, 1000);
        } catch (error) {
          console.error('Error switching to physical products:', error);
          showNotification('Error switching pages', 'error');
        }
      }

      function logout() {
        try {
          debugLog('Logging out user...');
          
          // Clear all authentication data
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          localStorage.removeItem('userData');
          localStorage.removeItem('user');
          
          // Clear session storage as well
          sessionStorage.clear();
          
          showNotification('Logging out...', 'info');
          
          // Redirect to login page
          setTimeout(() => {
            window.location.href = '/auth/login.html';
          }, 1000);
          
        } catch (error) {
          console.error('Error during logout:', error);
          showNotification('Error during logout', 'error');
          // Force redirect even if there's an error
          setTimeout(() => {
            window.location.href = '/auth/login.html';
          }, 2000);
        }
      }

      function clearAllFilters() {
        try {
          debugLog('Clearing all filters...');
          
          // Reset all filter elements
          const categoryFilter = document.getElementById('category-filter');
          const sortFilter = document.getElementById('sort-filter');
          const availabilityFilter = document.getElementById('availability-filter');
          const deliveryTimeFilter = document.getElementById('delivery-time-filter');
          const priceRange = document.getElementById('price-range');
          const searchInput = document.getElementById('search-input');
          
          if (categoryFilter) categoryFilter.value = '';
          if (sortFilter) sortFilter.value = 'distance';
          if (availabilityFilter) availabilityFilter.value = '';
          if (deliveryTimeFilter) deliveryTimeFilter.value = '';
          if (priceRange) priceRange.value = priceRange.max;
          if (searchInput) searchInput.value = '';
          
          // Reset filtered products to all products
          filteredProducts = [...allProducts];
          currentPage = 1;
          
          // Re-render products
          renderProducts();
          updateProductsCount();
          
          showNotification('All filters cleared', 'success');
          debugLog('All filters cleared');
        } catch (error) {
          console.error('Error clearing filters:', error);
          showNotification('Error clearing filters', 'error');
        }
      }

      function secureCheckout() {
        try {
          debugLog('Starting secure checkout...');
          
          if (shoppingMenu.length === 0) {
            showNotification('Your cart is empty', 'error');
            return;
          }
          
          // Call the existing proceedToCheckout function
          proceedToCheckout();
          
        } catch (error) {
          console.error('Error during checkout:', error);
          showNotification('Error starting checkout', 'error');
        }
      }

      function addToMenu(productId) {
        try {
          debugLog('Adding product to menu', { productId });
          
          // Find the product
          const product = allProducts.find(p => p.id == productId);
          if (!product) {
            showNotification('Product not found', 'error');
            return;
          }
          
          // Check if product is already in cart
          const existingItem = shoppingMenu.find(item => item.id == productId);
          
          if (existingItem) {
            // Increase quantity
            existingItem.quantity += 1;
            showNotification(`${product.product_name} quantity increased`, 'success');
          } else {
            // Add new item to cart
            const cartItem = {
              id: product.id,
              product_id: product.product_id,
              product_name: product.product_name,
              price: parseFloat(product.price || product.price_per_unit || 0),
              quantity: 1,
              seller_id: product.seller_id,
              seller_name: product.seller_name,
              main_image: product.main_image,
              unit_type: product.unit_type || 'unit'
            };
            
            shoppingMenu.push(cartItem);
            showNotification(`${product.product_name} added to cart`, 'success');
            // Referral tracking for local market add to cart
            try { trackLocalReferralConversion && trackLocalReferralConversion('add_to_cart', product.id, { quantity: 1 }); } catch(e) { /* ignore */ }
          }
          
          // Update cart display
          updateCartDisplay();
          
          debugLog('Product added to cart', { productName: product.product_name, cartSize: shoppingMenu.length });
          
        } catch (error) {
          console.error('Error adding to cart:', error);
          showNotification('Error adding product to cart', 'error');
        }
      }

      function updateCartDisplay() {
        try {
          const cartCount = shoppingMenu.reduce((total, item) => total + item.quantity, 0);
          const cartTotal = shoppingMenu.reduce((total, item) => total + (item.price * item.quantity), 0);
          
          // Update cart button if it exists
          const checkoutBtn = document.getElementById('checkout-btn');
          if (checkoutBtn) {
            checkoutBtn.disabled = cartCount === 0;
            checkoutBtn.innerHTML = cartCount > 0 
              ? `<i class="fas fa-shopping-cart mr-2"></i>Checkout (${cartCount} items - ${cartTotal.toLocaleString()} RWF)`
              : '<i class="fas fa-shopping-cart mr-2"></i>Your cart is empty';
          }
          
          debugLog('Cart display updated', { cartCount, cartTotal });
          
        } catch (error) {
          console.error('Error updating cart display:', error);
        }
      }

      // Order management functions
      async function viewOrderDetails(orderId) {
        try {
          debugLog('Viewing order details', { orderId });
          
          const response = await makeAuthenticatedRequest(`/api/local-market-orders/orders/${orderId}`);
          const data = await response.json();
          
          if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to fetch order details');
          }
          
          const order = data.order;
          showOrderDetailsModal(order);
          
        } catch (error) {
          console.error('Error viewing order details:', error);
          showNotification('Error loading order details', 'error');
        }
      }

      function showOrderDetailsModal(order) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h2 class="text-2xl font-bold text-gray-800">Order Details #${order.id}</h2>
              <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Order Information -->
                <div class="space-y-4">
                  <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">Order Information</h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span class="font-medium">${order.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Created:</span>
                        <span class="font-medium">${new Date(order.created_at).toLocaleString()}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Payment Status:</span>
                        <span class="font-medium">${order.payment_status}</span>
                      </div>
                      ${order.agent_id ? `
                        <div class="flex justify-between">
                          <span class="text-gray-600">Agent Assigned:</span>
                          <span class="font-medium">Yes</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  
                  <!-- Delivery Information -->
                  <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-3">Delivery Information</h3>
                    <p class="text-sm text-blue-700">${order.delivery_address || 'Address not provided'}</p>
                  </div>
                </div>
                
                <!-- Order Items -->
                <div class="space-y-4">
                  <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800 mb-3">Order Items</h3>
                    <div class="space-y-2">
                      ${order.items ? order.items.map(item => `
                        <div class="flex justify-between items-center text-sm">
                          <div>
                            <span class="font-medium">${item.product_name}</span>
                            <span class="text-gray-600">x${item.quantity}</span>
                          </div>
                          <span class="font-medium">${(item.total_price || 0).toLocaleString()} RWF</span>
                        </div>
                      `).join('') : '<p class="text-sm text-gray-600">No items found</p>'}
                    </div>
                  </div>
                  
                  <!-- Order Totals -->
                  <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-800 mb-3">Order Totals</h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span class="text-gray-600">Products Total:</span>
                        <span class="font-medium">${parseFloat(order.products_total || 0).toLocaleString()} RWF</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Platform Fee:</span>
                        <span class="font-medium">${parseFloat(order.platform_fee || 0).toLocaleString()} RWF</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Delivery Fee:</span>
                        <span class="font-medium">${parseFloat(order.delivery_fee || 0).toLocaleString()} RWF</span>
                      </div>
                      <hr class="my-2">
                      <div class="flex justify-between font-bold">
                        <span>Grand Total:</span>
                        <span>${parseFloat(order.grand_total || 0).toLocaleString()} RWF</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Order Timeline -->
              ${order.confirmed_at || order.delivered_at ? `
                <div class="mt-6 bg-purple-50 p-4 rounded-lg">
                  <h3 class="font-semibold text-purple-800 mb-3">Order Timeline</h3>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Order Placed:</span>
                      <span class="font-medium">${new Date(order.created_at).toLocaleString()}</span>
                    </div>
                    ${order.confirmed_at ? `
                      <div class="flex justify-between">
                        <span class="text-gray-600">Confirmed:</span>
                        <span class="font-medium">${new Date(order.confirmed_at).toLocaleString()}</span>
                      </div>
                    ` : ''}
                    ${order.delivered_at ? `
                      <div class="flex justify-between">
                        <span class="text-gray-600">Delivered:</span>
                        <span class="font-medium">${new Date(order.delivered_at).toLocaleString()}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}
              
              <!-- Action Buttons -->
              <div class="mt-6 flex space-x-4">
                ${order.payment_status === 'pending' ? `
                  <button onclick="submitPaymentProof('${order.id}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-receipt mr-2"></i>Submit Payment Proof
                  </button>
                ` : ''}
                
                ${order.status === 'delivered' && !order.delivery_confirmed ? `
                  <button onclick="confirmDelivery('${order.id}')" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>Confirm Delivery
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      async function submitPaymentProof(orderId) {
        try {
          debugLog('Submitting payment proof', { orderId });
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="bg-white rounded-2xl max-w-2xl w-full">
              <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Submit Payment Proof</h2>
                <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              <div class="p-6">
                <form id="payment-proof-form" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select name="payment_method" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                      <option value="mtn_mobile_money">MTN Mobile Money</option>
                      <option value="airtel_money">Airtel Money</option>
                      <option value="bank_transfer">Bank Transfer</option>
                    </select>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Transaction ID</label>
                    <input type="text" name="transaction_id" class="w-full border border-gray-300 rounded-lg px-3 py-2" required placeholder="Enter transaction ID">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Phone Number</label>
                    <input type="tel" name="payment_phone" class="w-full border border-gray-300 rounded-lg px-3 py-2" required placeholder="+250 XXX XXX XXX">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount Paid (RWF)</label>
                    <input type="number" name="amount" class="w-full border border-gray-300 rounded-lg px-3 py-2" required placeholder="Enter amount">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Proof Image URL (Optional)</label>
                    <input type="url" name="proof_image" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="https://example.com/screenshot.jpg">
                    <p class="text-xs text-gray-500 mt-1">Upload your payment screenshot to an image hosting service and paste the URL here</p>
                  </div>
                  
                  <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                      <i class="fas fa-paper-plane mr-2"></i>Submit Proof
                    </button>
                    <button type="button" onclick="closeModal(this)" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // Handle form submission
          const form = document.getElementById('payment-proof-form');
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const paymentData = {
              payment_method: formData.get('payment_method'),
              transaction_id: formData.get('transaction_id'),
              payment_phone: formData.get('payment_phone'),
              amount: parseFloat(formData.get('amount')),
              proof_image: formData.get('proof_image') || null
            };
            
            try {
              const response = await makeAuthenticatedRequest(`/api/local-market-orders/orders/${orderId}/payment-proof`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(paymentData)
              });
              
              const result = await response.json();
              
              if (response.ok && result.success) {
                showNotification('Payment proof submitted successfully!', 'success');
                closeModal(modal.querySelector('button'));
                loadUserOrders(); // Refresh orders list
              } else {
                throw new Error(result.message || 'Failed to submit payment proof');
              }
              
            } catch (error) {
              console.error('Error submitting payment proof:', error);
              showNotification('Error submitting payment proof: ' + error.message, 'error');
            }
          });
          
        } catch (error) {
          console.error('Error showing payment proof form:', error);
          showNotification('Error loading payment form', 'error');
        }
      }

      async function confirmDelivery(orderId) {
        try {
          debugLog('Confirming delivery', { orderId });
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="bg-white rounded-2xl max-w-lg w-full">
              <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Confirm Delivery</h2>
                <button onclick="closeModal(this)" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              <div class="p-6">
                <form id="delivery-confirmation-form" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rate your experience (1-5 stars)</label>
                    <div class="flex space-x-2">
                      ${[1,2,3,4,5].map(star => `
                        <button type="button" onclick="setRating(${star})" class="rating-star text-2xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="${star}">
                          ‚≠ê
                        </button>
                      `).join('')}
                    </div>
                    <input type="hidden" name="rating" id="selected-rating" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Feedback (Optional)</label>
                    <textarea name="feedback" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Share your experience with this order..."></textarea>
                  </div>
                  
                  <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                      <i class="fas fa-check mr-2"></i>Confirm Delivery
                    </button>
                    <button type="button" onclick="closeModal(this)" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // Handle form submission
          const form = document.getElementById('delivery-confirmation-form');
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const confirmationData = {
              rating: parseInt(formData.get('rating')),
              feedback: formData.get('feedback') || null
            };
            
            if (!confirmationData.rating) {
              showNotification('Please select a rating', 'error');
              return;
            }
            
            try {
              const response = await makeAuthenticatedRequest(`/api/local-market-orders/orders/${orderId}/confirm-delivery`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(confirmationData)
              });
              
              const result = await response.json();
              
              if (response.ok && result.success) {
                showNotification('Delivery confirmed successfully!', 'success');
                closeModal(modal.querySelector('button'));
                loadUserOrders(); // Refresh orders list
              } else {
                throw new Error(result.message || 'Failed to confirm delivery');
              }
              
            } catch (error) {
              console.error('Error confirming delivery:', error);
              showNotification('Error confirming delivery: ' + error.message, 'error');
            }
          });
          
        } catch (error) {
          console.error('Error showing delivery confirmation form:', error);
          showNotification('Error loading confirmation form', 'error');
        }
      }

      function setRating(rating) {
        document.getElementById('selected-rating').value = rating;
        
        // Update star display
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
          } else {
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
          }
        });
      }
      
      // Expose functions globally (functions defined above)
      window.toggleUserMenu = toggleUserMenu;
      window.showMyOrders = showMyOrders;
      window.showProfile = showProfile;
      window.showHelpSupport = showHelpSupport;
      window.closeModal = closeModal;
      window.copyToClipboard = copyToClipboard;
      window.editProfile = editProfile;
      window.changePassword = changePassword;
      window.loadUserOrders = loadUserOrders;
      window.switchToPhysicalProducts = switchToPhysicalProducts;
      window.logout = logout;
      window.clearAllFilters = clearAllFilters;
      window.secureCheckout = secureCheckout;
      window.addToMenu = addToMenu;
      window.updateCartDisplay = updateCartDisplay;
      window.viewOrderDetails = viewOrderDetails;
      window.submitPaymentProof = submitPaymentProof;
      window.confirmDelivery = confirmDelivery;
      window.setRating = setRating;
      window.loadProducts = loadProducts;
      window.loadSampleProducts = loadSampleProducts;
      window.renderProducts = renderProducts;
      window.proceedToCheckout = proceedToCheckout;
      window.loadMoreProducts = loadMoreProducts;
      window.updateProductsCount = updateProductsCount;
      
      // Close user dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userDropdown = document.getElementById('user-dropdown');
        
        if (!userMenuBtn.contains(event.target) && !userDropdown.contains(event.target)) {
          userDropdown.classList.add('hidden');
        }
      });

      // This function is replaced by the enhanced logout function above
      // Keeping for backward compatibility but redirecting to the enhanced version

      function updateLocation() {
        alert('Location update feature - Coming soon');
      }

      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            updateLocationDisplay();
            // Reload products with new location
            loadProducts();
          });
        }
      }

      // Filter functions
      function applyFilters() {
        try {
          const categoryFilter = document.getElementById('category-filter').value;
          const sortFilter = document.getElementById('sort-filter').value;
          const availabilityFilter = document.getElementById('availability-filter').value;
          const deliveryTimeFilter = document.getElementById('delivery-time-filter').value;

          debugLog('Applying filters', { categoryFilter, sortFilter, availabilityFilter, deliveryTimeFilter });

          // Start with all products
          let filtered = [...allProducts];

          // Apply category filter
          if (categoryFilter) {
            filtered = filtered.filter(product => 
              product.category && product.category.toLowerCase().includes(categoryFilter.toLowerCase())
            );
          }

          // Apply availability filter
          if (availabilityFilter === 'in_stock') {
            filtered = filtered.filter(product => (product.stock_quantity || 0) > 0);
          } else if (availabilityFilter === 'low_stock') {
            filtered = filtered.filter(product => {
              const stock = product.stock_quantity || 0;
              return stock > 0 && stock <= 10;
            });
          }

          // Apply sorting
          if (sortFilter === 'price_low') {
            filtered.sort((a, b) => (a.price_per_unit || 0) - (b.price_per_unit || 0));
          } else if (sortFilter === 'price_high') {
            filtered.sort((a, b) => (b.price_per_unit || 0) - (a.price_per_unit || 0));
          } else if (sortFilter === 'distance') {
            filtered.sort((a, b) => (a.distance || 0) - (b.distance || 0));
          } else if (sortFilter === 'name') {
            filtered.sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));
          }

          filteredProducts = filtered;
          currentPage = 1; // Reset to first page
          renderProducts();
          updateProductsCount();

          debugLog('Filters applied', { originalCount: allProducts.length, filteredCount: filtered.length });
        } catch (error) {
          console.error('Error applying filters:', error);
          showNotification('Error applying filters', 'error');
        }
      }

      function clearAllFilters() {
        try {
          // Reset all filter inputs
          document.getElementById('category-filter').value = '';
          document.getElementById('sort-filter').value = '';
          document.getElementById('availability-filter').value = '';
          document.getElementById('delivery-time-filter').value = '';
          
          // Reset price range if it exists
          const priceRange = document.getElementById('price-range');
          if (priceRange) {
            priceRange.value = priceRange.max;
          }

          // Reset filtered products to all products
          filteredProducts = [...allProducts];
          currentPage = 1;
          renderProducts();
          updateProductsCount();

          showNotification('All filters cleared', 'success');
          debugLog('All filters cleared');
        } catch (error) {
          console.error('Error clearing filters:', error);
          showNotification('Error clearing filters', 'error');
        }
      }

      function handlePriceRange() {
        try {
          const priceRange = document.getElementById('price-range');
          const maxPrice = parseInt(priceRange.value) || 0;
          
          // Update price display if it exists
          const priceDisplay = document.getElementById('price-display');
          if (priceDisplay) {
            priceDisplay.textContent = `Up to ${maxPrice.toLocaleString()} RWF`;
          }

          // Filter products by price
          filteredProducts = allProducts.filter(product => 
            (product.price_per_unit || 0) <= maxPrice
          );
          
          currentPage = 1;
          renderProducts();
          updateProductsCount();

          debugLog('Price filter applied', { maxPrice, filteredCount: filteredProducts.length });
        } catch (error) {
          console.error('Error handling price range:', error);
        }
      }

      function handleSearch(event) {
        try {
          const searchTerm = event.target.value.toLowerCase().trim();
          debugLog('Search term entered', { searchTerm });

          if (!searchTerm) {
            filteredProducts = [...allProducts];
          } else {
            filteredProducts = allProducts.filter(product => {
              const name = (product.product_name || '').toLowerCase();
              const description = (product.description || '').toLowerCase();
              const category = (product.category || '').toLowerCase();
              const seller = (product.seller_name || '').toLowerCase();
              
              return name.includes(searchTerm) || 
                     description.includes(searchTerm) || 
                     category.includes(searchTerm) || 
                     seller.includes(searchTerm);
            });
          }

          currentPage = 1;
          renderProducts();
          updateProductsCount();

          debugLog('Search completed', { searchTerm, resultsCount: filteredProducts.length });
        } catch (error) {
          console.error('Error handling search:', error);
          showNotification('Error performing search', 'error');
        }
      }

      function resetSearch() {
        try {
          // Clear search inputs
          const searchInputs = ['header-search', 'mobile-search-bar'];
          searchInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
              input.value = '';
            }
          });

          // Reset to all products
          filteredProducts = [...allProducts];
          currentPage = 1;
          renderProducts();
          updateProductsCount();

          showNotification('Search cleared', 'success');
          debugLog('Search reset');
        } catch (error) {
          console.error('Error resetting search:', error);
        }
      }

      function loadMoreProducts() {
        try {
          currentPage++;
          renderProducts();
          debugLog('Loaded more products', { currentPage });
        } catch (error) {
          console.error('Error loading more products:', error);
          showNotification('Error loading more products', 'error');
        }
      }

      // Global function for adding to menu
      window.addToMenu = function(productId) {
        try {
          debugLog('Adding product to menu', { productId, allProductsCount: allProducts.length });
          
          // Handle both string and numeric IDs
          const product = allProducts.find(p => p.id == productId || p.id === productId);
          if (!product) {
            console.error('Product not found:', productId);
            showNotification('Product not found', 'error');
            return;
          }

          const qtyInput = document.getElementById(`qty-${productId}`);
          if (!qtyInput) {
            console.error('Quantity input not found for product:', productId);
            showNotification('Unable to add product', 'error');
            return;
          }

          const quantity = parseInt(qtyInput.value) || 1;
          
          // Validate quantity
          if (quantity <= 0) {
            showNotification('Please enter a valid quantity', 'warning');
            return;
          }
          
          if (quantity > (product.stock_quantity || 0)) {
            showNotification('Not enough stock available', 'warning');
            return;
          }

          // Check if product already in menu
          const existingIndex = shoppingMenu.findIndex(item => item.id == productId);
          
          if (existingIndex >= 0) {
            const newQuantity = shoppingMenu[existingIndex].quantity + quantity;
            if (newQuantity > (product.stock_quantity || 0)) {
              showNotification('Not enough stock for this quantity', 'warning');
              return;
            }
            shoppingMenu[existingIndex].quantity = newQuantity;
          } else {
            shoppingMenu.push({
              id: product.id,
              name: product.product_name || product.name || 'Unknown Product',
              price: parseFloat(product.price_per_unit) || parseFloat(product.price) || 0,
              unit: product.unit_type || product.unit || 'unit',
              quantity: quantity,
              image: product.main_image || product.image || '/public/images/placeholder-product.jpg',
              seller_id: product.seller_id || null
            });
          }

          renderMenu();
          debugLog('Product added to menu successfully', { productId, quantity, menuSize: shoppingMenu.length });
          
          // Show success feedback
          qtyInput.value = 1;
          const button = qtyInput.parentElement.nextElementSibling;
          if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Added!';
            button.classList.add('bg-green-700');
            setTimeout(() => {
              button.innerHTML = originalText;
              button.classList.remove('bg-green-700');
            }, 1000);
          }
          
          showNotification('Product added to menu!', 'success');
        } catch (error) {
          console.error('Error adding product to menu:', error);
          showNotification('Error adding product to menu', 'error');
        }
      };

      // Global function for removing from menu
      window.removeFromMenu = function(index) {
        shoppingMenu.splice(index, 1);
        renderMenu();
      };

      function renderMenu() {
        menuItemCount.textContent = shoppingMenu.length;
        if (shoppingMenu.length === 0) {
          menuItemsList.innerHTML = '<p class="text-center text-gray-500 py-8">Your menu is empty.</p>';
          costBreakdown.classList.add('hidden');
          deliveryInfoSetup.classList.add('hidden');
          checkoutBtn.disabled = true;
          return;
        }

        menuItemsList.innerHTML = shoppingMenu.map((item, index) => `
          <div class="flex items-center gap-3 menu-item-enter">
            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
            <div class="flex-1">
              <p class="font-semibold text-sm">${item.name}</p>
              <p class="text-xs text-gray-500">${item.quantity} ${item.unit} x ${item.price} RWF</p>
            </div>
            <div class="text-sm font-bold">${item.quantity * item.price} RWF</div>
            <button onclick="window.removeFromMenu(${index})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
          </div>
        `).join('');

        updateTotals();
        costBreakdown.classList.remove('hidden');
        deliveryInfoSetup.classList.remove('hidden');
        checkoutBtn.disabled = false;