<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Market | African Deals Domain</title>
  <style id="critical-css">*,*::before,*::after{box-sizing: border-box} html{line-height: 1.15;-webkit-text-size-adjust: 100%} body{margin: 0;font-family: 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size: 16px;line-height: 1.6;color: #1f2937;background-color: #f9fafb} .container{max-width: 1200px;margin: 0 auto;padding: 0 1rem} .flex{display: flex} .grid{display: grid} .hidden{display: none} .sr-only{position: absolute;width: 1px;height: 1px;padding: 0;margin: -1px;overflow: hidden;clip: rect(0,0,0,0);white-space: nowrap;border: 0} header{position: sticky;top: 0;z-index: 50;background: rgba(255,255,255,0.95);backdrop-filter: blur(10px);border-bottom: 1px solid #e5e7eb;box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1)} .logo{height: 3rem;width: 3rem;border-radius: 0.75rem;box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);transition: transform 0.3s ease} .logo:hover{transform: scale(1.1)} .brand-text{font-weight: 800;font-size: 1.5rem;background: linear-gradient(135deg,#0e2038 0%,#23325c 50%,#1e3a8a 100%);-webkit-background-clip: text;-webkit-text-fill-color: transparent;background-clip: text} .loading-shimmer{background: linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size: 200% 100%;animation: shimmer 1.5s infinite} @keyframes shimmer{0%{background-position: -200% 0} 100%{background-position: 200% 0} } .fade-in{animation: fadeIn 0.6s ease-out} @keyframes fadeIn{from{opacity: 0} to{opacity: 1} } .btn{display: inline-flex;align-items: center;justify-content: center;padding: 0.5rem 1rem;border-radius: 0.375rem;font-weight: 500;text-decoration: none;transition: all 0.2s ease;cursor: pointer;border: none} .btn-primary{background: linear-gradient(135deg,#3b82f6,#1d4ed8);color: white} .btn-primary:hover{background: linear-gradient(135deg,#2563eb,#1e40af);transform: translateY(-1px);box-shadow: 0 4px 12px rgba(59,130,246,0.4)} input,select,textarea{width: 100%;padding: 0.75rem;border: 1px solid #d1d5db;border-radius: 0.375rem;font-size: 1rem;transition: border-color 0.2s ease} input:focus,select:focus,textarea:focus{outline: none;border-color: #3b82f6;box-shadow: 0 0 0 3px rgba(59,130,246,0.1)} @media (max-width: 768px){.container{padding: 0 0.5rem} .brand-text{font-size: 1.25rem} .btn{padding: 0.5rem 0.75rem;font-size: 0.875rem} } .below-fold{opacity: 0;transition: opacity 0.3s ease} .lazy-load{opacity: 0;transition: opacity 0.3s ease} .hero-section{background: linear-gradient(135deg,#0e2038 0%,#23325c 50%,#1e3a8a 100%);color: white;padding: 4rem 0;text-align: center} .hero-title{font-size: 3rem;font-weight: 800;margin-bottom: 1rem;line-height: 1.2} .hero-subtitle{font-size: 1.25rem;opacity: 0.9;margin-bottom: 2rem} .search-bar{max-width: 600px;margin: 0 auto;position: relative} .search-input{width: 100%;padding: 1rem 3rem 1rem 1rem;border: none;border-radius: 0.5rem;font-size: 1.125rem;box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1)} .category-grid{display: grid;grid-template-columns: repeat(auto-fit,minmax(200px,1fr));gap: 1.5rem;margin: 3rem 0} .category-card{background: white;border-radius: 0.75rem;padding: 1.5rem;text-align: center;box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);transition: transform 0.2s ease,box-shadow 0.2s ease} .category-card:hover{transform: translateY(-4px);box-shadow: 0 8px 25px -5px rgba(0,0,0,0.15)} @media (max-width: 768px){.hero-title{font-size: 2rem} .hero-subtitle{font-size: 1rem} .category-grid{grid-template-columns: repeat(auto-fit,minmax(150px,1fr));gap: 1rem} } .dashboard-header{background: white;border-bottom: 1px solid #e5e7eb;padding: 1.5rem 0} .dashboard-nav{display: flex;gap: 2rem;margin: 1rem 0} .nav-item{padding: 0.75rem 1.5rem;border-radius: 0.5rem;text-decoration: none;color: #6b7280;font-weight: 500;transition: all 0.2s ease} .nav-item.active{background: #3b82f6;color: white} .nav-item:hover{background: #f3f4f6;color: #374151} .stats-grid{display: grid;grid-template-columns: repeat(auto-fit,minmax(250px,1fr));gap: 1.5rem;margin: 2rem 0} .stat-card{background: white;border-radius: 0.75rem;padding: 1.5rem;box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1)} .stat-value{font-size: 2rem;font-weight: 700;color: #1f2937} .stat-label{color: #6b7280;font-size: 0.875rem;margin-top: 0.5rem}</style>
  <link rel="icon" href="/public/images/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/public/css/tailwind.css">
  <link rel="stylesheet" href="/shared/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>window.__LEAFLET_ENABLED__ = false;</script>
  <!-- Inline auth utilities to avoid external file errors -->
  <script>
    // Auth utilities inline
    function getAuthToken() {
      return localStorage.getItem('authToken') || localStorage.getItem('token');
    }
    
    function isAuthenticated() {
      const token = getAuthToken();
      return token && token !== 'null' && token !== 'undefined';
    }
    
    function redirectToLogin() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('token');
      window.location.href = '/public/login.html';
    }
    
    // Mode switcher inline
    window.modeSwitcher = {
      switchMode: function(mode) {
        if (mode === 'physical') {
          window.location.href = '/buyer/buyers-home.html';
        } else if (mode === 'grocery') {
          window.location.href = '/grocery/local-market-home-signed.html';
        }
      }
    };
  </script>
  <style>
    /* Enhanced Animations */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .slide-up { animation: slideUp 0.4s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .menu-item-enter { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    
    .bounce-in { animation: bounceIn 0.6s ease-out; }
    @keyframes bounceIn { 
      0% { opacity: 0; transform: scale(0.3); }
      50% { opacity: 1; transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    /* Layout Improvements */
    .sticky-cart { position: sticky; top: 6rem; }
    #map-preview { height: 200px; min-height: 200px; }
    
    /* Enhanced Product Cards */
    .product-card { 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
    }
    .product-card:hover { 
      transform: translateY(-8px) scale(1.02); 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      border-color: #10b981;
    }
    
    /* Loading States */
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .skeleton { 
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    
    /* Glass Effects */
    .glass { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .glass-dark { 
      background: rgba(0, 0, 0, 0.7); 
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Gradient Backgrounds */
    .gradient-bg { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    .gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    
    /* Enhanced Buttons */
    .btn-floating {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .btn-floating:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
    }
    
    /* Enhanced Form Elements */
    .form-input {
      transition: all 0.2s ease;
      border: 2px solid #e5e7eb;
    }
    .form-input:focus {
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      transform: translateY(-1px);
    }
    
    /* Tab Enhancements */
    .tab-btn {
      position: relative;
      overflow: hidden;
    }
    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .tab-btn:hover::before {
      left: 100%;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .product-card:hover {
        transform: translateY(-4px) scale(1.01);
      }
      
      .btn-floating {
        bottom: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
      }
      
      #map-preview {
        height: 150px;
        min-height: 150px;
      }
      
      .glass {
        backdrop-filter: blur(8px);
      }
      
      /* Ensure tabs are responsive */
      .tab-btn {
        min-width: 80px;
        font-size: 0.875rem;
      }
      
      .tab-btn span {
        display: inline !important;
      }
    }
    
    /* Navigation Fixes */
    .tab-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
      color: white !important;
    }
    
    /* Ensure proper spacing */
    body {
      padding-top: 0;
    }
    
    /* Fix any layout issues */
    .max-w-8xl {
      max-width: 1280px;
    }
    
    /* Cart Badge */
    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Enhanced Modals */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-50px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* Status Indicators */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-dot.online { background: #10b981; }
    .status-dot.offline { background: #ef4444; }
    .status-dot.busy { background: #f59e0b; }
    
    /* Enhanced Scrollbars */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>

      <script>
        // Ensure shared styles are present (already linked above as fallback)
        window.addEventListener('load', function() {
          if (!document.querySelector('link[href="/shared/styles.css"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/shared/styles.css';
            document.head.appendChild(link);
          }
        });
      </script>
      </head>
<body class="bg-green-50">

  <!-- Header -->
  <header class="bg-white shadow-lg sticky top-0 z-40 border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo & Brand -->
        <div class="flex items-center gap-3">
          <a href="/buyer/buyers-home.html" class="flex items-center gap-2">
            <img src="/public/images/logo.png" alt="ADD Logo" class="h-10 w-10 rounded-lg shadow-md" />
            <div class="hidden sm:block">
              <h1 class="font-bold text-lg text-green-700">🛒 Local Market</h1>
              <p class="text-xs text-gray-500 -mt-1">Fresh • Fast • Local</p>
            </div>
          </a>
        </div>

        <!-- Search Bar (Desktop) -->
        <div class="hidden md:flex flex-1 max-w-md mx-6">
          <div class="relative w-full">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
            <input type="text" id="header-search" placeholder="Search products..." 
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
          <!-- Cart Button -->
          <button onclick="switchTab('cart')" class="relative p-2 text-gray-600 hover:text-green-700 rounded-lg hover:bg-green-50 transition-colors">
            <i class="fas fa-shopping-cart text-lg"></i>
            <span id="header-cart-badge" class="cart-badge hidden">0</span>
          </button>
          
          <!-- Mode Switch -->
          <button id="switch-to-physical" class="hidden lg:flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-medium transition-colors text-sm">
            <i class="fas fa-box-open text-sm"></i>
            <span>Physical Products</span>
          </button>
          
          <!-- Mobile Menu -->
          <button id="mobile-menu-toggle" class="md:hidden p-2 text-gray-600 hover:text-green-700 rounded-lg hover:bg-green-50 transition-colors">
            <i class="fas fa-bars text-lg"></i>
          </button>
          
          <!-- User Menu (Desktop) -->
          <div class="hidden md:block relative">
            <button id="user-menu-btn" class="flex items-center gap-2 text-gray-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors">
              <div class="w-7 h-7 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-green-600 text-xs"></i>
              </div>
              <span id="user-name" class="font-medium text-sm">User</span>
              <i class="fas fa-chevron-down text-xs"></i>
            </button>
            
            <!-- Dropdown -->
            <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50">
              <div class="py-1">
                <button onclick="switchTab('orders')" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left text-sm">
                  <i class="fas fa-receipt text-green-600"></i>
                  <span>My Orders</span>
                </button>
                <button onclick="switchTab('profile')" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left text-sm">
                  <i class="fas fa-user text-green-600"></i>
                  <span>Profile</span>
                </button>
                <button onclick="openSupportModal()" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-green-50 transition-colors w-full text-left text-sm">
                  <i class="fas fa-headset text-green-600"></i>
                  <span>Support</span>
                </button>
                <hr class="my-1">
                <button id="logout-btn" class="flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors w-full text-left text-sm">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Navigation Menu -->
  <div id="mobile-nav" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop fixed inset-0" onclick="closeMobileNav()"></div>
    <div class="fixed top-0 right-0 h-full w-72 max-w-full bg-white shadow-xl transform translate-x-full transition-transform duration-300" id="mobile-nav-panel">
      <div class="p-4">
        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-800">Menu</h2>
          <button onclick="closeMobileNav()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i class="fas fa-times text-gray-600"></i>
          </button>
        </div>
        
        <nav class="space-y-2">
          <button onclick="switchTab('browse'); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-green-50 transition-colors text-left">
            <i class="fas fa-store text-green-600"></i>
            <span class="text-gray-700">Browse Products</span>
          </button>
          <button onclick="switchTab('cart'); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-green-50 transition-colors text-left">
            <i class="fas fa-shopping-cart text-green-600"></i>
            <span class="text-gray-700">My Cart</span>
            <span id="mobile-cart-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
          </button>
          <button onclick="switchTab('orders'); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-green-50 transition-colors text-left">
            <i class="fas fa-receipt text-green-600"></i>
            <span class="text-gray-700">My Orders</span>
          </button>
          <button onclick="switchTab('profile'); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-green-50 transition-colors text-left">
            <i class="fas fa-user text-green-600"></i>
            <span class="text-gray-700">Profile</span>
          </button>
          
          <hr class="my-4">
          
          <button onclick="window.modeSwitcher.switchMode('physical')" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-blue-50 transition-colors text-left">
            <i class="fas fa-box-open text-blue-600"></i>
            <span class="text-gray-700">Physical Products</span>
          </button>
          <button onclick="openSupportModal(); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-purple-50 transition-colors text-left">
            <i class="fas fa-headset text-purple-600"></i>
            <span class="text-gray-700">Help & Support</span>
          </button>
          
          <hr class="my-4">
          
          <button onclick="logout(); closeMobileNav();" class="flex items-center gap-3 w-full p-3 rounded-lg hover:bg-red-50 text-red-600 transition-colors text-left">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </nav>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Tabs Navigation -->
    <nav class="mb-6" aria-label="Local Market sections">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200">
        <div class="flex gap-1 overflow-x-auto p-2 custom-scrollbar" role="tablist">
          <button id="tab-browse" class="tab-btn flex-1 px-4 py-3 rounded-lg text-sm font-medium gradient-bg text-white shadow-md whitespace-nowrap transition-all duration-200" data-tab="browse" role="tab" aria-selected="true" aria-controls="browse-content">
            <i class="fas fa-store mr-2" aria-hidden="true"></i>
            <span>Browse Products</span>
          </button>
          <button id="tab-cart" class="tab-btn flex-1 px-4 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all duration-200 whitespace-nowrap relative" data-tab="cart" role="tab" aria-selected="false" aria-controls="cart-content">
            <i class="fas fa-shopping-cart mr-2" aria-hidden="true"></i>
            <span>My Cart</span>
            <span id="tab-cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full hidden">0</span>
          </button>
          <button id="tab-orders" class="tab-btn flex-1 px-4 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all duration-200 whitespace-nowrap" data-tab="orders" role="tab" aria-selected="false" aria-controls="orders-panel">
            <i class="fas fa-receipt mr-2" aria-hidden="true"></i>
            <span>My Orders</span>
          </button>
          <button id="tab-profile" class="tab-btn flex-1 px-4 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all duration-200 whitespace-nowrap" data-tab="profile" role="tab" aria-selected="false" aria-controls="profile-panel">
            <i class="fas fa-user mr-2" aria-hidden="true"></i>
            <span>Profile</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Tab Content -->
    <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- Tab Panels -->
    <section id="orders-panel" class="col-span-1 lg:col-span-4 hidden" role="tabpanel" aria-labelledby="tab-orders">
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">My Orders</h2>
            <p class="text-sm text-gray-600">View and track your grocery orders</p>
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm" onclick="document.querySelector('[data-tab=\'browse\']')?.click()">
            <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i>Back to Browse
          </button>
        </div>
        <div id="orders-panel-content" class="space-y-4">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2" aria-hidden="true"></i>
            <p>Loading your orders...</p>
          </div>
        </div>
      </div>
    </section>

    <section id="profile-panel" class="col-span-1 lg:col-span-4 hidden" role="tabpanel" aria-labelledby="tab-profile">
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">My Profile</h2>
            <p class="text-sm text-gray-600">Manage your personal information</p>
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm" onclick="document.querySelector('[data-tab=\'browse\']')?.click()">
            <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i>Back to Browse
          </button>
        </div>
        <div id="profile-panel-content" class="space-y-4">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2" aria-hidden="true"></i>
            <p>Loading your profile...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Browse Content (default visible) -->
    <!-- Left Column: Filters and Products -->
    <div id="browse-content" class="lg:col-span-3 space-y-8" role="tabpanel" aria-labelledby="tab-browse">
      
      <!-- Location & Search/Filter Panel -->
      <section class="bg-white rounded-2xl shadow-lg p-6 fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          <!-- Location Info -->
          <div>
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-map-marker-alt text-xl text-green-600"></i>
              </div>
              <div>
                <h2 class="text-xl font-bold text-gray-800">Delivery Zone</h2>
                <p id="location-indicator" class="text-sm text-gray-600">
                  <i class="fas fa-spinner loading-spinner mr-1"></i>
                  Detecting your location...
                </p>
              </div>
            </div>
            <div id="map-preview" class="rounded-xl border border-gray-200 bg-gray-100 relative overflow-hidden">
              <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
                <div class="text-center">
                  <i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2"></i>
                  <p class="text-sm text-gray-500">Loading map...</p>
                </div>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button id="update-location-btn" class="flex-1 bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors">
                <i class="fas fa-location-crosshairs mr-2"></i>Update Location
              </button>
              <button id="use-current-location-btn" class="bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors" title="Use current location">
                <i class="fas fa-crosshairs"></i>
              </button>
              <button id="choose-location-btn" class="bg-purple-100 text-purple-800 font-semibold py-2 px-4 rounded-lg hover:bg-purple-200 transition-colors" title="Choose location on map">
                <i class="fas fa-map-pin"></i>
              </button>
            </div>
          </div>

          <!-- Search & Filters -->
          <div>
            <!-- Mobile Search (shown on mobile) -->
            <div class="lg:hidden relative mb-4">
              <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true"></i>
              <label for="mobile-search-bar" class="sr-only">Search products</label>
              <input type="text" id="mobile-search-bar" placeholder="Search products..." class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500" autocomplete="off">
            </div>

            <!-- Filters -->
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                  <select id="category-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">All Categories</option>
                    <!-- Categories will be loaded dynamically -->
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                  <select id="sort-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="name">Name (A-Z)</option>
                    <option value="price_low">Price (Low to High)</option>
                    <option value="price_high">Price (High to Low)</option>
                    <option value="rating">Highest Rated</option>
                    <option value="newest">Newest First</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
                <div class="px-2">
                  <input type="range" id="price-range" min="0" max="10000" value="10000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                  <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0 RWF</span>
                    <span id="price-range-value">10,000 RWF</span>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Availability</label>
                  <select id="availability-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">All Products</option>
                    <option value="in_stock">In Stock Only</option>
                    <option value="low_stock">Low Stock</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Delivery</label>
                  <select id="delivery-time-filter" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    <option value="">Any Time</option>
                    <option value="fast">Under 1 hour</option>
                    <option value="standard">1-2 hours</option>
                    <option value="scheduled">Scheduled</option>
                  </select>
                </div>
              </div>

              <button id="clear-filters-btn" class="w-full bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">
                <i class="fas fa-times mr-2"></i>Clear All Filters
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Product Listings -->
      <section>
        <!-- Section Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Available Products</h2>
            <p id="products-count" class="text-sm text-gray-600" aria-live="polite">Loading products...</p>
          </div>
          <div class="flex items-center gap-2" role="group" aria-label="View mode">
            <button id="grid-view-btn" class="p-2 bg-green-100 text-green-600 rounded-lg" aria-pressed="true" title="Grid view">
              <i class="fas fa-th-large" aria-hidden="true"></i>
            </button>
            <button id="list-view-btn" class="p-2 text-gray-400 hover:bg-gray-100 rounded-lg" aria-pressed="false" title="List view">
              <i class="fas fa-list" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="products-loading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 md:gap-6">
          <!-- Loading skeletons -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden hidden lg:block">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden hidden xl:block">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden hidden 2xl:block">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden hidden 2xl:block">
            <div class="h-48 skeleton"></div>
            <div class="p-4 space-y-3">
              <div class="h-4 skeleton rounded w-3/4"></div>
              <div class="h-3 skeleton rounded w-1/2"></div>
              <div class="flex justify-between items-center">
                <div class="h-6 skeleton rounded w-1/4"></div>
                <div class="h-8 skeleton rounded w-16"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div id="product-listings" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 md:gap-6 hidden" role="region" aria-live="polite" aria-label="Products">
          <!-- Product cards will be injected here by JS -->
        </div>

        <!-- No Products State -->
        <div id="no-products" class="text-center py-16 hidden">
          <div class="w-32 h-32 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center mx-auto mb-6 bounce-in">
            <i class="fas fa-shopping-basket text-4xl text-green-600"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-800 mb-3">No Products Found</h3>
          <p class="text-gray-600 mb-6 max-w-md mx-auto">We couldn't find any products matching your criteria. Try adjusting your filters or search terms to discover more items.</p>
          <div class="space-y-3">
            <button id="reset-search-btn" class="gradient-bg text-white px-8 py-3 rounded-xl hover:shadow-lg transition-all duration-300 font-medium">
              <i class="fas fa-refresh mr-2"></i>Reset Search
            </button>
            <button onclick="document.getElementById('header-search').focus()" class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-200 transition-colors">
              <i class="fas fa-search mr-2"></i>Try Different Search
            </button>
          </div>
        </div>

        <!-- Load More Button -->
        <div id="load-more-container" class="text-center mt-12 hidden">
          <button id="load-more-btn" class="bg-white border-2 border-green-200 text-green-700 px-10 py-4 rounded-2xl hover:bg-green-50 hover:border-green-300 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl">
            <i class="fas fa-plus mr-3"></i>Load More Products
          </button>
          <p class="text-sm text-gray-500 mt-3">Discover more fresh products</p>
        </div>
      </section>
    </div>

    <!-- Right Column: Shopping Menu (Cart) -->
    <aside id="cart-content" class="lg:col-span-1" role="tabpanel" aria-labelledby="tab-cart">
      <div class="sticky-cart">
        <div id="shopping-menu" class="bg-white rounded-2xl shadow-lg p-6 space-y-6" role="region" aria-label="Shopping menu">
          <!-- Title -->
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-800" id="cart-title">Shopping Menu</h2>
            <span id="menu-item-count" class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full" aria-live="polite" aria-label="Items in cart">0</span>
          </div>

          <!-- Item List -->
          <div id="menu-items-list" class="space-y-4 max-h-64 overflow-y-auto pr-2">
            <p class="text-center text-gray-500 py-8">Your menu is empty. Add items to get started!</p>
          </div>

          <!-- Cost Breakdown -->
          <div id="cost-breakdown" class="border-t border-gray-200 pt-4 space-y-2 text-sm hidden">
            <div class="flex justify-between">
              <span class="text-gray-600">Products Total</span>
              <span id="products-total">0 RWF</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Platform Fee (1%)</span>
              <span id="platform-fee">0 RWF</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Packaging Fee</span>
              <span id="packaging-fee">200 RWF</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Delivery Fee</span>
              <span id="delivery-fee">1500 RWF</span>
            </div>
            <div class="flex justify-between font-bold text-lg text-gray-800 border-t border-gray-200 pt-2 mt-2">
              <span>Grand Total</span>
              <span id="grand-total">1700 RWF</span>
            </div>
          </div>

          <!-- Delivery Info Setup -->
          <div id="delivery-info-setup" class="border-t border-gray-200 pt-4 space-y-3 hidden">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Time Window</label>
              <select class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                <option>ASAP (30-60 min)</option>
                <option>In 1-2 hours</option>
                <option>In 2-4 hours</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Note (Optional)</label>
              <textarea rows="2" placeholder="e.g., Call upon arrival" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></textarea>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button onclick="saveMenuForLater()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-xl transition-colors text-sm">
              <i class="fas fa-bookmark mr-2"></i>Save Menu for Later
            </button>
            <button onclick="loadSavedMenu()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 rounded-xl transition-colors text-sm">
              <i class="fas fa-history mr-2"></i>Load Saved Menu
            </button>
            <button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
              <i class="fas fa-shopping-cart mr-2"></i>Confirm & Checkout
            </button>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script src="/grocery/missing-functions.js"></script>
  <script src="/grocery/local-market-core.js"></script>
  <script src="/grocery/local-market-product-modal.js"></script>
  <script>
    // Tabs controller
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
      const browseContent = document.getElementById('browse-content');
      const cartContent = document.getElementById('cart-content');
      const ordersPanel = document.getElementById('orders-panel');
      const profilePanel = document.getElementById('profile-panel');

      async function loadOrdersIntoPanel() {
        const content = document.getElementById('orders-panel-content');
        content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2"></i><p>Loading your orders...</p></div>';
        try {
          const token = getAuthToken();
          const response = await fetch('/api/local-market/orders/my-orders', {
            headers: { 'Authorization': "Bearer " + (token) + "" }
          });
          
          if (!response.ok) {
            throw new Error("HTTP " + (response.status) + "");
          }
          
          const result = await response.json();
          if (result.success && result.orders.length > 0) {
            content.innerHTML = "
              <div class="space-y-4">
                ${result.orders.map(order => "
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                      <div>
                        <h4 class="font-semibold text-gray-800">Order #${order.id}</h4>
                        <p class="text-sm text-gray-600">${new Date(order.created_at).toLocaleDateString()}</p>
                      </div>
                      <span class="px-3 py-1 rounded-full text-xs font-medium ${getOrderStatusClass(order.status)}">
                        ${order.status.toUpperCase()}
                      </span>
                    </div>
                    <div class="space-y-2 text-sm">
                      <p><strong>Total:</strong> ${order.total_amount} RWF</p>
                      <p><strong>Items:</strong> ${order.items ? JSON.parse(order.items).length : 0} products</p>
                      <p><strong>Delivery:</strong> ${order.delivery_address}</p>
                    </div>
                    <div class="mt-3 flex gap-2">
                      <button onclick="viewOrderDetails(${order.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View Details
                      </button>
                      ${order.status === 'confirmed' ? "
                        <button onclick="trackOrder(" + (order.id) + ")" class="text-green-600 hover:text-green-800 text-sm font-medium">
                          Track Order
                        </button>
                      " : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          } else {
            content.innerHTML = `
              <div class="text-center py-8">
                <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-800 mb-2">No Orders Yet</h3>
                <p class="text-gray-600">Start shopping to see your orders here!</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading orders:', error);
          // Show demo orders when API fails
          content.innerHTML = "
            <div class="space-y-4">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2">
                  <i class="fas fa-info-circle text-yellow-600"></i>
                  <p class="text-sm text-yellow-800">Showing demo data - API unavailable</p>
                </div>
              </div>
              <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h4 class="font-semibold text-gray-800">Order #DEMO001</h4>
                    <p class="text-sm text-gray-600">" + (new Date().toLocaleDateString()) + "</p>
                  </div>
                  <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    CONFIRMED
                  </span>
                </div>
                <div class="space-y-2 text-sm">
                  <p><strong>Total:</strong> 3,500 RWF</p>
                  <p><strong>Items:</strong> 3 products</p>
                  <p><strong>Delivery:</strong> Demo Address, Kigali</p>
                </div>
                <div class="mt-3 flex gap-2">
                  <button onclick="showNotification('Demo order details', 'info')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    View Details
                  </button>
                  <button onclick="showNotification('Demo tracking info', 'info')" class="text-green-600 hover:text-green-800 text-sm font-medium">
                    Track Order
                  </button>
                </div>
              </div>
            </div>
          ";
        }
      }

      async function loadProfileIntoPanel() {
        const content = document.getElementById('profile-panel-content');
        content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner loading-spinner text-2xl text-gray-400 mb-2"></i><p>Loading profile...</p></div>';
        try {
          const token = getAuthToken();
          const response = await fetch('/api/users/profile', {
            headers: { 'Authorization': "Bearer " + (token) + "" }
          });
          
          if (!response.ok) {
            throw new Error("HTTP " + (response.status) + "");
          }
          
          const result = await response.json();
          if (result.success) {
            const user = result.user;
            content.innerHTML = "
              <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="profile-name" value="" + (user.full_name || '') + "" class="w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="profile-email" value="" + (user.email || '') + "" class="w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" id="profile-phone" value="" + (user.phone || '') + "" class="w-full p-3 border border-gray-300 rounded-lg">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea id="profile-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg">" + (user.address || '') + "</textarea>
                  </div>
                  <div class="flex gap-3">
                    <button type="button" onclick="updateProfile()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                      Update Profile
                    </button>
                  </div>
                </div>
                <div class="space-y-4">
                  <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Account</h4>
                    <p class="text-sm text-gray-600">Username: <strong>" + (user.username || '-') + "</strong></p>
                    <p class="text-sm text-gray-600">Member since: <strong>" + (new Date(user.created_at || Date.now()).toLocaleDateString()) + "</strong></p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Notifications</h4>
                    <p class="text-sm text-gray-600">Email notifications are enabled.</p>
                  </div>
                </div>
              </div>
            ";
          } else {
            content.innerHTML = '<div class="text-center py-8 text-red-600">Error loading profile</div>';
          }
        } catch (error) {
          console.error('Error loading profile:', error);
          // Show demo profile when API fails
          content.innerHTML = "
            <div class="grid md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                  <div class="flex items-center gap-2">
                    <i class="fas fa-info-circle text-yellow-600"></i>
                    <p class="text-sm text-yellow-800">Showing demo profile - API unavailable</p>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                  <input type="text" id="profile-name" value="Demo User" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" id="profile-email" value="demo@example.com" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <input type="tel" id="profile-phone" value="+250 123 456 789" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <textarea id="profile-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg">Demo Address, Kigali, Rwanda</textarea>
                </div>
                <div class="flex gap-3">
                  <button type="button" onclick="showNotification('Demo profile update', 'info')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                    Update Profile
                  </button>
                </div>
              </div>
              <div class="space-y-4">
                <div class="bg-gray-50 rounded-lg p-4">
                  <h4 class="font-semibold text-gray-800 mb-3">Account</h4>
                  <p class="text-sm text-gray-600">Username: <strong>demo_user</strong></p>
                  <p class="text-sm text-gray-600">Member since: <strong>" + (new Date().toLocaleDateString()) + "</strong></p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                  <h4 class="font-semibold text-gray-800 mb-3">Notifications</h4>
                  <p class="text-sm text-gray-600">Email notifications are enabled.</p>
                </div>
              </div>
            </div>
          ";
        }
      }

      function activateTab(tab) {
        // Reset buttons
        tabButtons.forEach(btn => {
          const active = btn.dataset.tab === tab;
          btn.className = 'tab-btn px-4 py-2 rounded-lg text-sm font-medium ' + (active ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200');
        });
        // Toggle sections
        ordersPanel.classList.add('hidden');
        profilePanel.classList.add('hidden');
        if (tab === 'browse') {
          browseContent.classList.remove('hidden');
          cartContent.classList.remove('hidden');
        } else if (tab === 'cart') {
          browseContent.classList.add('hidden');
          ordersPanel.classList.add('hidden');
          profilePanel.classList.add('hidden');
          cartContent.classList.remove('hidden');
          cartContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else if (tab === 'orders') {
          browseContent.classList.add('hidden');
          cartContent.classList.add('hidden');
          ordersPanel.classList.remove('hidden');
          loadOrdersIntoPanel();
        } else if (tab === 'profile') {
          browseContent.classList.add('hidden');
          cartContent.classList.add('hidden');
          profilePanel.classList.remove('hidden');
          loadProfileIntoPanel();
        }
      }

      // Alias for switchTab (used in onclick handlers)
      function switchTab(tab) {
        activateTab(tab);
      }

      tabButtons.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));
      // Default
      activateTab('browse');
      
      } catch (error) {
        console.error('Error during page initialization:', error);
        if (typeof showNotification === 'function') {
          showNotification('Page initialization error. Some features may not work properly.', 'warning');
        }
      }
    });

    // Reuse existing helpers
    function getOrderStatusClass(status) {
      switch (status) {
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'confirmed': return 'bg-green-100 text-green-800';
        case 'processing': return 'bg-blue-100 text-blue-800';
        case 'delivered': return 'bg-purple-100 text-purple-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }
  </script>

  <!-- Post-Order Confirmation Modal -->
  <div id="order-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center fade-in">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check-circle text-5xl text-green-500"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-3">Order Placed Successfully!</h2>
      <p class="text-gray-600 mb-6">Your fresh groceries are on the way. You can track the delivery in real-time.</p>
      
      <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
        <h3 class="font-semibold text-gray-700 mb-3">Order Summary</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Order Number:</span>
            <span class="font-mono">#LM-12345</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Estimated Delivery:</span>
            <span class="font-semibold text-green-600">35-50 minutes</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Assigned Agent:</span>
            <div class="flex items-center gap-2">
              <img src="/public/images/logo.png" alt="Agent" class="w-6 h-6 rounded-full">
              <span class="font-semibold">John D.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-4">
        <a href="/buyer/track-order.html?id=12345" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
          <i class="fas fa-map-location-dot mr-2"></i>Track Delivery
        </a>
        <a href="/buyer/orders.html" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-colors">
          View Full Order Details
        </a>
      </div>
      <button id="close-modal-btn" class="mt-6 text-sm text-gray-500 hover:underline">Close</button>
    </div>
  </div>

  <!-- Product Details Modal -->
  <div id="product-details-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">Product Details</h2>
        <button onclick="closeProductDetailsModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="product-details-content" class="p-6">
        <!-- Product details will be loaded here -->
        <div class="animate-pulse">
          <div class="h-48 bg-gray-200 rounded-lg mb-4"></div>
          <div class="h-6 bg-gray-200 rounded mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Track Location Modal -->
  <div id="track-location-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-800">Seller Location & Delivery Info</h2>
        <button onclick="closeTrackLocationModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-6">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Map Section -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Seller Location</h3>
            <div id="seller-map" class="h-64 rounded-lg border border-gray-300"></div>
            <div class="mt-4 space-y-2 text-sm">
              <div class="flex items-center gap-2">
                <i class="fas fa-map-marker-alt text-red-500"></i>
                <span id="seller-address">Loading address...</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-route text-blue-500"></i>
                <span id="delivery-distance">Calculating distance...</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-clock text-green-500"></i>
                <span id="estimated-delivery">Estimating delivery time...</span>
              </div>
            </div>
          </div>
          
          <!-- Seller Info Section -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Seller Information</h3>
            <div id="seller-info-content" class="space-y-4">
              <!-- Seller info will be loaded here -->
              <div class="animate-pulse">
                <div class="h-4 bg-gray-200 rounded mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
              </div>
            </div>
            
            <div class="mt-6 space-y-3">
              <button type="button" onclick="event.preventDefault(); contactSeller(); return false;" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                <i class="fas fa-phone mr-2"></i>Contact Seller
              </button>
              <button type="button" onclick="event.preventDefault(); requestDeliveryUpdate(); return false;" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-xl transition-colors">
                <i class="fas fa-truck mr-2"></i>Request Delivery Update
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Check authentication (supports both 'authToken' and 'token')
        const token = getAuthToken();
        if (!isAuthenticated()) {
          window.location.href = '/public/login.html';
          return;
        }

      // Global variables
      let allProducts = [];
      let filteredProducts = [];
      const shoppingMenu = [];
      let userLocation = { lat: -1.9441, lng: 30.0619 }; // Default Kigali
      let currentPage = 1;
      const productsPerPage = 12;

      // --- LEAFLET MAP INITIALIZATION ---
      let map;
      try {
        if (window.L && typeof L !== 'undefined') {
          // Check if map container exists before initializing
          const mapContainer = document.getElementById('map-preview');
          if (mapContainer) {
            map = L.map('map-preview').setView([-1.9441, 30.0619], 13); // Default to Kigali
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([-1.9441, 30.0619]).addTo(map).bindPopup('Your delivery zone.');
            
            // Hide loading indicator after map loads
            setTimeout(() => {
              const mapLoading = document.getElementById('map-loading');
              if (mapLoading) mapLoading.classList.add('hidden');
            }, 1000);
          }
        } else {
          // Offline or Leaflet not loaded
          const mapLoading = document.getElementById('map-loading');
          if (mapLoading) mapLoading.classList.add('hidden');
          const indicator = document.getElementById('location-indicator');
          if (indicator) indicator.innerHTML = '<span class="text-gray-500">Map unavailable offline</span>';
        }
      } catch (e) {
        console.warn('Map init skipped:', e);
        const mapLoading = document.getElementById('map-loading');
        if (mapLoading) mapLoading.classList.add('hidden');
      }

      // --- DOM ELEMENTS ---
      const productListings = document.getElementById('product-listings');
      const menuItemsList = document.getElementById('menu-items-list');
      const menuItemCount = document.getElementById('menu-item-count');
      const costBreakdown = document.getElementById('cost-breakdown');
      const deliveryInfoSetup = document.getElementById('delivery-info-setup');
      const checkoutBtn = document.getElementById('checkout-btn');
      const productsTotalEl = document.getElementById('products-total');
      const platformFeeEl = document.getElementById('platform-fee');
      const grandTotalEl = document.getElementById('grand-total');
      const orderConfirmationModal = document.getElementById('order-confirmation-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');

      // CRITICAL: Make functions globally available BEFORE initializing page
      // This must happen before any HTML with onclick handlers is generated
      window.viewProductDetails = viewProductDetails;
      window.closeProductDetailsModal = closeProductDetailsModal;
      window.addToMenuFromModal = addToMenuFromModal;
      window.trackOrderLocation = trackOrderLocation;
      window.closeTrackLocationModal = closeTrackLocationModal;
      window.contactSeller = contactSeller;
      window.requestDeliveryUpdate = requestDeliveryUpdate;
      window.addToMenu = addToMenu;
      window.shareProduct = shareProduct;
      window.handleCheckout = handleCheckout;
      window.openOrdersModal = openOrdersModal;
      window.closeOrdersModal = closeOrdersModal;
      window.openProfileModal = openProfileModal;
      window.closeProfileModal = closeProfileModal;
      window.openSupportModal = openSupportModal;
      window.closeSupportModal = closeSupportModal;
      window.openCheckoutModal = openCheckoutModal;
      window.closeCheckoutModal = closeCheckoutModal;
      window.openPaymentProofModal = openPaymentProofModal;
      window.closePaymentProofModal = closePaymentProofModal;
      window.handlePaymentProofUpload = handlePaymentProofUpload;
      window.saveAsDraft = saveAsDraft;
      window.submitPaymentProof = submitPaymentProof;
      window.updateProfile = updateProfile;
      window.submitSupportRequest = submitSupportRequest;
      window.switchTab = switchTab; // Add switchTab function
      window.activateTab = activateTab; // Also expose activateTab
      window.closeOrderModal = closeOrdersModal; // Alias for compatibility
      // Provide a global logout handler used by the header button
      window.logout = function() {
        try {
          localStorage.removeItem('authToken');
          localStorage.removeItem('token');
          sessionStorage.removeItem('authToken');
        } catch (e) {}
        window.location.href = '/public/login.html';
      };
      
      // Debug: Log that functions are available
      console.log('✅ All functions assigned to global scope BEFORE page initialization:', {
        addToMenu: typeof window.addToMenu,
        viewProductDetails: typeof window.viewProductDetails,
        trackOrderLocation: typeof window.trackOrderLocation,
        shareProduct: typeof window.shareProduct,
        closeOrderModal: typeof window.closeOrderModal
      });

      // Initialize the page
      initializePage();

      function initializePage() {
        loadUserInfo();
        loadCategories();
        loadProducts();
        setupEventListeners();
        initializeMap();
      }

      function loadUserInfo() {
        fetch('/api/auth/profile', {
          headers: { 'Authorization': "Bearer " + (token) + "" }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('user-name').textContent = data.user.name;
            if (data.user.latitude && data.user.longitude) {
              userLocation = { lat: data.user.latitude, lng: data.user.longitude };
              updateLocationDisplay();
            }
          }
        })
        .catch(error => console.error('Error loading user info:', error));
      }

      function loadCategories() {
        fetch('/api/grocery/categories', {
          headers: { 'Authorization': "Bearer " + (token) + "" }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const categorySelect = document.getElementById('category-filter');
            data.categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category.name.toLowerCase();
              option.textContent = category.name;
              categorySelect.appendChild(option);
            });
          }
        })
        .catch(error => console.error('Error loading categories:', error));
      }

      function loadProducts() {
        showProductsLoading(true);
        
        fetch('/api/local-market-orders/products', {
          headers: { 'Authorization': "Bearer " + (token) + "" }
        })
        .then(response => response.json())
        .then(data => {
          showProductsLoading(false);
          if (data.success) {
            allProducts = data.products;
            filteredProducts = allProducts;
            renderProducts();
            updateProductsCount();
            console.log('Products loaded successfully:', allProducts.length, 'products');
          } else {
            showNoProducts();
            console.error('Failed to load products:', data.message);
          }
        })
        .catch(error => {
          showProductsLoading(false);
          console.error('Error loading products:', error);
          showNoProducts();
        });
      }

      function renderProducts() {
        const productListings = document.getElementById('product-listings');
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsToShow = filteredProducts.slice(startIndex, endIndex);

        if (productsToShow.length === 0) {
          showNoProducts();
          return;
        }

        productListings.classList.remove('hidden');
        document.getElementById('no-products').classList.add('hidden');

        productListings.innerHTML = productsToShow.map(product => "
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden product-card fade-in">
            <div class="relative">
              <img src="" + (product.main_image || '/public/images/placeholder-product.jpg') + "" 
                   alt="" + (product.product_name) + "" class="w-full h-48 object-cover">
              <div class="absolute top-4 right-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full " + (product.stock_quantity > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + "">
                  " + (product.stock_quantity > 0 ? 'In Stock' : 'Out of Stock') + "
                </span>
              </div>
              ${product.stock_quantity <= 10 && product.stock_quantity > 0 ? "
                <div class="absolute top-4 left-4">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                    Low Stock
                  </span>
                </div>
              " : ''}
            </div>
            
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-800 mb-2">" + (product.product_name) + "</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">" + (product.description) + "</p>
              
              <div class="flex items-center justify-between mb-4">
                <div>
                  <span class="text-2xl font-bold text-green-600">" + (product.price_per_unit.toLocaleString()) + " RWF</span>
                  <span class="text-gray-500 text-sm">/ " + (product.unit_type) + "</span>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Available</p>
                  <p class="font-semibold">" + (product.stock_quantity) + " " + (product.unit_type) + "</p>
                </div>
              </div>
              
              <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span><i class="fas fa-tag mr-1"></i>" + (product.category) + "</span>
                <span><i class="fas fa-map-marker-alt mr-1"></i>" + (calculateDistance(product.latitude, product.longitude).toFixed(1)) + " km</span>
              </div>
              
              ${product.stock_quantity > 0 ? "
                <div class="flex items-center gap-2 mb-4">
                  <label class="text-sm font-medium">Qty:</label>
                  <input type="number" id="qty-${product.id}" value="1" min="1" max="${product.stock_quantity}" 
                         class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-green-500">
                  <span class="text-sm text-gray-600">${product.unit_type}</span>
                </div>
                <div class="space-y-2">
                  <button onclick="addToMenu(${product.id})" 
                          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition-colors shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Add to Menu
                  </button>
                  <div class="grid grid-cols-2 gap-2">
                    <button type="button" onclick="viewProductDetails(${product.id})" 
                            class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 rounded-xl transition-colors text-sm">
                      <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                    <button type="button" onclick="trackOrderLocation(${product.seller_id})" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 rounded-xl transition-colors text-sm">
                      <i class="fas fa-map-marker-alt mr-1"></i>Track Location
                    </button>
                  </div>
                  <button type="button" onclick="shareProduct(${product.id})" 
                          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-xl transition-colors text-sm">
                    <i class="fas fa-share-alt mr-2"></i>Share & Earn ${Math.round((product.price_per_unit - (product.price_per_unit / 1.21)) * 0.15).toLocaleString()} RWF
                  </button>
                </div>
              ` : `
                <button disabled class="w-full bg-gray-400 text-white font-semibold py-3 rounded-xl cursor-not-allowed">
                  <i class="fas fa-times mr-2"></i>Out of Stock
                </button>
              `}
            </div>
          </div>
        `).join('');

        // Update load more button
        updateLoadMoreButton();
      }

      // Utility functions
      function showProductsLoading(show) {
        const loadingDiv = document.getElementById('products-loading');
        const productsDiv = document.getElementById('product-listings');
        const noProductsDiv = document.getElementById('no-products');
        
        if (show) {
          loadingDiv.classList.remove('hidden');
          productsDiv.classList.add('hidden');
          noProductsDiv.classList.add('hidden');
        } else {
          loadingDiv.classList.add('hidden');
        }
      }

      function showNoProducts() {
        document.getElementById('products-loading').classList.add('hidden');
        document.getElementById('product-listings').classList.add('hidden');
        document.getElementById('no-products').classList.remove('hidden');
      }

      function updateProductsCount() {
        const count = filteredProducts.length;
        document.getElementById('products-count').textContent = "" + (count) + " products found";
      }

      function updateLoadMoreButton() {
        const loadMoreContainer = document.getElementById('load-more-container');
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        
        if (currentPage < totalPages) {
          loadMoreContainer.classList.remove('hidden');
        } else {
          loadMoreContainer.classList.add('hidden');
        }
      }

      function calculateDistance(lat1, lng1) {
        const lat2 = userLocation.lat;
        const lng2 = userLocation.lng;
        
        const R = 6371; // Radius of the Earth in kilometers
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      function initializeMap() {
        try {
          if (!window.L || typeof L === 'undefined') {
            // Leaflet not available (offline or blocked)
            const indicator = document.getElementById('location-indicator');
            if (indicator) indicator.innerHTML = '<span class="text-gray-500">Map unavailable offline</span>';
            const mapLoading = document.getElementById('map-loading');
            if (mapLoading) mapLoading.classList.add('hidden');
            return;
          }
          
          // Check if map container exists and is not already initialized
          const mapContainer = document.getElementById('map-preview');
          if (!mapContainer) {
            console.warn('Map container not found');
            return;
          }
          
          // Avoid reinitializing if map already exists
          if (map) {
            map.setView([userLocation.lat, userLocation.lng], 13);
            return;
          }
          
          map = L.map('map-preview').setView([userLocation.lat, userLocation.lng], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([userLocation.lat, userLocation.lng]).addTo(map).bindPopup('Your location');
          
          // Hide loading indicator
          setTimeout(() => {
            const mapLoading = document.getElementById('map-loading');
            if (mapLoading) mapLoading.classList.add('hidden');
          }, 1000);
        } catch (e) {
          console.warn('initializeMap skipped:', e);
          const mapLoading = document.getElementById('map-loading');
          if (mapLoading) mapLoading.classList.add('hidden');
        }
      }

      function updateLocationDisplay() {
        document.getElementById('location-indicator').innerHTML = `
          <i class="fas fa-map-marker-alt mr-1"></i>
          Showing products near your location
        `;
      }

      function setupEventListeners() {
        // Search functionality
        const searchInputs = ['header-search', 'mobile-search-bar'];
        searchInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener('input', debounce(handleSearch, 300));
          }
        });

        // Filter functionality - Add null checks
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
        
        const sortFilter = document.getElementById('sort-filter');
        if (sortFilter) sortFilter.addEventListener('change', applyFilters);
        
        const availabilityFilter = document.getElementById('availability-filter');
        if (availabilityFilter) availabilityFilter.addEventListener('change', applyFilters);
        
        const deliveryTimeFilter = document.getElementById('delivery-time-filter');
        if (deliveryTimeFilter) deliveryTimeFilter.addEventListener('change', applyFilters);
        
        const priceRange = document.getElementById('price-range');
        if (priceRange) priceRange.addEventListener('input', handlePriceRange);

        // Clear filters
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearFilters);

        // Load more products
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) loadMoreBtn.addEventListener('click', loadMoreProducts);

        // Reset search
        const resetSearchBtn = document.getElementById('reset-search-btn');
        if (resetSearchBtn) resetSearchBtn.addEventListener('click', resetSearch);

        // User menu
        const userMenuBtn = document.getElementById('user-menu-btn');
        if (userMenuBtn) {
          userMenuBtn.addEventListener('click', toggleUserMenu);
        }

        // Logout button
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', logout);
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
          const userMenu = document.getElementById('user-dropdown');
          if (userMenu && !userMenu.contains(e.target) && !userMenuBtn.contains(e.target)) {
            userMenu.classList.add('hidden');
          }
        });
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Mobile Navigation Functions
      function openMobileNav() {
        const mobileNav = document.getElementById('mobile-nav');
        const mobileNavPanel = document.getElementById('mobile-nav-panel');
        if (mobileNav && mobileNavPanel) {
          mobileNav.classList.remove('hidden');
          setTimeout(() => {
            mobileNavPanel.classList.remove('translate-x-full');
          }, 10);
        }
      }

      function closeMobileNav() {
        const mobileNav = document.getElementById('mobile-nav');
        const mobileNavPanel = document.getElementById('mobile-nav-panel');
        if (mobileNav && mobileNavPanel) {
          mobileNavPanel.classList.add('translate-x-full');
          setTimeout(() => {
            mobileNav.classList.add('hidden');
          }, 300);
        }
      }

      // User Menu Functions
      function toggleUserMenu() {
        const dropdown = document.getElementById('user-dropdown');
        if (dropdown) {
          dropdown.classList.toggle('hidden');
        }
      }

      function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('localMarketCart');
        localStorage.removeItem('draftOrder');
        window.location.href = '/public/login.html';
      }

      // Toast notification function
      function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = "fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-white font-medium shadow-lg transition-all duration-300 transform translate-x-0 " + (
          type === 'error' ? 'bg-red-500' : 
          type === 'warning' ? 'bg-yellow-500' : 
          type === 'success' ? 'bg-green-500' : 'bg-blue-500'
        ) + "";
        
        toast.innerHTML = "
          <div class="flex items-center gap-2">
            <i class="fas " + (
              type === 'error' ? 'fa-exclamation-circle' : 
              type === 'warning' ? 'fa-exclamation-triangle' : 
              type === 'success' ? 'fa-check-circle' : 'fa-info-circle'
            ) + ""></i>
            <span>" + (message) + "</span>
          </div>
        ";
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
          toast.style.transform = 'translateX(0)';
        }, 10);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 4000);
      }

      // Alias for compatibility
      window.showToast = showNotification;

      // Error boundary for graceful error handling
      window.addEventListener('error', function(event) {
        console.error('Global error caught:', event.error);
        showNotification('An error occurred. Please refresh the page.', 'error');
      });

      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        showNotification('Connection error. Using offline mode.', 'warning');
        event.preventDefault();
      });

      function handleSearch(e) {
        const query = e.target.value.toLowerCase().trim();
        if (query === '') {
          filteredProducts = allProducts;
        } else {
          filteredProducts = allProducts.filter(product =>
            product.product_name.toLowerCase().includes(query) ||
            product.description.toLowerCase().includes(query) ||
            product.category.toLowerCase().includes(query)
          );
        }
        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function applyFilters() {
        const category = document.getElementById('category-filter').value;
        const sort = document.getElementById('sort-filter').value;
        const availability = document.getElementById('availability-filter').value;
        const deliveryTime = document.getElementById('delivery-time-filter').value;
        const maxPrice = parseInt(document.getElementById('price-range').value);

        filteredProducts = allProducts.filter(product => {
          if (category && product.category.toLowerCase() !== category) return false;
          if (availability === 'in_stock' && product.stock_quantity <= 0) return false;
          if (availability === 'low_stock' && product.stock_quantity > 10) return false;
          if (product.price_per_unit > maxPrice) return false;
          return true;
        });

        // Apply sorting
        if (sort === 'price_low') {
          filteredProducts.sort((a, b) => a.price_per_unit - b.price_per_unit);
        } else if (sort === 'price_high') {
          filteredProducts.sort((a, b) => b.price_per_unit - a.price_per_unit);
        } else if (sort === 'name') {
          filteredProducts.sort((a, b) => a.product_name.localeCompare(b.product_name));
        } else if (sort === 'newest') {
          filteredProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function handlePriceRange(e) {
        const value = e.target.value;
        document.getElementById('price-range-value').textContent = "" + (parseInt(value).toLocaleString()) + " RWF";
        applyFilters();
      }

      function clearFilters() {
        document.getElementById('category-filter').value = '';
        document.getElementById('sort-filter').value = 'name';
        document.getElementById('availability-filter').value = '';
        document.getElementById('delivery-time-filter').value = '';
        document.getElementById('price-range').value = '10000';
        document.getElementById('price-range-value').textContent = '10,000 RWF';
        
        // Clear search inputs
        const searchInputs = ['header-search', 'mobile-search-bar'];
        searchInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) input.value = '';
        });

        filteredProducts = allProducts;
        currentPage = 1;
        renderProducts();
        updateProductsCount();
      }

      function loadMoreProducts() {
        currentPage++;
        renderProducts();
      }

      function resetSearch() {
        clearFilters();
      }

      function toggleUserMenu() {
        document.getElementById('user-dropdown').classList.toggle('hidden');
      }

      function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/public/login.html';
      }

      function updateLocation() {
        alert('Location update feature - Coming soon');
      }

      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            updateLocationDisplay();
            // Reload products with new location
            loadProducts();
          });
        }
      }



      // Global function for removing from menu
      window.removeFromMenu = function(index) {
        shoppingMenu.splice(index, 1);
        renderMenu();
      };

      // Global function for saving menu for later
      window.saveMenuForLater = function() {
        if (shoppingMenu.length === 0) {
          showToast('Your menu is empty', 'error');
          return;
        }

        // Save to localStorage
        localStorage.setItem('savedLocalMarketMenu', JSON.stringify(shoppingMenu));
        showToast('Menu saved for later!', 'success');
      };

      // Function to load saved menu
      function loadSavedMenu() {
        const savedMenu = localStorage.getItem('savedLocalMarketMenu');
        if (savedMenu) {
          try {
            shoppingMenu = JSON.parse(savedMenu);
            renderMenu();
            showToast('Saved menu loaded!', 'success');
          } catch (error) {
            console.error('Error loading saved menu:', error);
          }
        }
      }

      // Share & Earn functionality
      window.shareProduct = function(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        // Calculate commission using the same logic as buyers-home.html
        const shownPrice = parseFloat(product.price_per_unit || product.price || 0);
        const platformCommission = shownPrice - (shownPrice / 1.21);
        const referralCommission = platformCommission * 0.15; // 15% of platform commission
        
        createShareModal(product, referralCommission);
      };

      function createShareModal(product, commission) {
        const formattedCommission = formatPrice(commission);
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = "
          <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center mb-6">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-share-alt text-2xl text-green-600"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Share & Earn</h3>
              <p class="text-gray-600">Share this product and earn commission on every sale!</p>
            </div>
            
            <div class="bg-green-50 rounded-xl p-4 mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-600">You'll earn per sale:</p>
                  <span class="font-semibold text-green-800 text-lg">" + (formattedCommission) + " RWF</span>
                </div>
                <div class="text-right">
                  <p class="text-xs text-gray-500">Commission Rate</p>
                  <p class="text-sm font-medium">15% of platform fee</p>
                </div>
              </div>
            </div>

            <div class="space-y-3 mb-6">
              <button onclick="shareToWhatsApp('" + (product.id) + "', '" + (commission) + "')" class="w-full flex items-center justify-center gap-3 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl transition-colors">
                <i class="fab fa-whatsapp text-xl"></i>
                <span>Share on WhatsApp</span>
              </button>
              
              <button onclick="shareToFacebook('" + (product.id) + "', '" + (commission) + "')" class="w-full flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl transition-colors">
                <i class="fab fa-facebook text-xl"></i>
                <span>Share on Facebook</span>
              </button>
              
              <button onclick="copyReferralLink('" + (product.id) + "', '" + (commission) + "')" class="w-full flex items-center justify-center gap-3 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl transition-colors">
                <i class="fas fa-copy text-xl"></i>
                <span>Copy Link</span>
              </button>
            </div>

            <button onclick="closeShareModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-xl transition-colors">
              Close
            </button>
          </div>
        ";
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeShareModal();
          }
        });
      }

      window.closeShareModal = function() {
        const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
        if (modal) {
          modal.remove();
        }
      };

      window.shareToWhatsApp = function(productId, commission) {
        const product = allProducts.find(p => p.id === productId);
        const referralCode = generateReferralCode();
        const productUrl = "" + (window.location.origin) + "/grocery/local-market-product-detail.html?id=" + (productId) + "&ref=" + (referralCode) + "";
        const message = "🛒 Check out this amazing product: " + (product.product_name) + "\n💰 Price: " + (formatPrice(product.price_per_unit)) + " RWF\n🔗 " + (productUrl) + "\n\n*I earn " + (formatPrice(commission)) + " RWF when you buy through my link!*";
        
        // Track referral generation
        trackReferralGeneration(productId, referralCode, 'whatsapp');
        
        window.open("https://wa.me/?text=" + (encodeURIComponent(message)) + "", '_blank');
        closeShareModal();
      };

      window.shareToFacebook = function(productId, commission) {
        const product = allProducts.find(p => p.id === productId);
        const referralCode = generateReferralCode();
        const productUrl = "" + (window.location.origin) + "/grocery/local-market-product-detail.html?id=" + (productId) + "&ref=" + (referralCode) + "";
        
        // Track referral generation
        trackReferralGeneration(productId, referralCode, 'facebook');
        
        window.open("https://www.facebook.com/sharer/sharer.php?u=" + (encodeURIComponent(productUrl)) + "", '_blank');
        closeShareModal();
      };

      window.copyReferralLink = function(productId, commission) {
        const referralCode = generateReferralCode();
        const productUrl = "" + (window.location.origin) + "/grocery/local-market-product-detail.html?id=" + (productId) + "&ref=" + (referralCode) + "";
        
        // Track referral generation
        trackReferralGeneration(productId, referralCode, 'direct_link');
        
        navigator.clipboard.writeText(productUrl).then(() => {
          showToast('Referral link copied to clipboard!', 'success');
          closeShareModal();
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = productUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showToast('Referral link copied to clipboard!', 'success');
          closeShareModal();
        });
      };

      function generateReferralCode() {
        const userId = JSON.parse(localStorage.getItem('userData') || '{}').id || 'anonymous';
        return "" + (userId) + "_" + (Date.now()) + "_" + (Math.random().toString(36).substr(2, 5)) + "";
      }

      function trackReferralGeneration(productId, referralCode, platform) {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        
        fetch('/api/referrals/track-generation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': "Bearer " + (token) + ""
          },
          body: JSON.stringify({
            userId: userData.id,
            productId: productId,
            platform: platform,
            referralCode: referralCode,
            generatedAt: new Date().toISOString()
          })
        }).catch(error => {
          console.error('Error tracking referral generation:', error);
        });
      }

      function formatPrice(price) {
        return Math.round(parseFloat(price) || 0).toLocaleString();
      }

      function renderMenu() {
        menuItemCount.textContent = shoppingMenu.length;
        if (shoppingMenu.length === 0) {
          menuItemsList.innerHTML = '<p class="text-center text-gray-500 py-8">Your menu is empty.</p>';
          costBreakdown.classList.add('hidden');
          deliveryInfoSetup.classList.add('hidden');
          checkoutBtn.disabled = true;
          return;
        }

        menuItemsList.innerHTML = shoppingMenu.map((item, index) => "
          <div class="flex items-center gap-3 menu-item-enter">
            <img src="" + (item.image) + "" alt="" + (item.name) + "" class="w-12 h-12 rounded-lg object-cover">
            <div class="flex-1">
              <p class="font-semibold text-sm">" + (item.name) + "</p>
              <p class="text-xs text-gray-500">" + (item.quantity) + " " + (item.unit) + " x " + (item.price) + " RWF</p>
            </div>
            <div class="text-sm font-bold">" + (item.quantity * item.price) + " RWF</div>
            <button onclick="window.removeFromMenu(" + (index) + ")" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
          </div>
        ").join('');

        updateTotals();
        costBreakdown.classList.remove('hidden');
        deliveryInfoSetup.classList.remove('hidden');
        checkoutBtn.disabled = false;
      }

      function updateTotals() {
        const productsTotal = shoppingMenu.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const platformFee = productsTotal * 0.01;
        const packagingFee = 200;
        const deliveryFee = 1500;
        const grandTotal = productsTotal + platformFee + packagingFee + deliveryFee;

        productsTotalEl.textContent = "" + (productsTotal.toFixed(0)) + " RWF";
        platformFeeEl.textContent = "" + (platformFee.toFixed(0)) + " RWF";
        grandTotalEl.textContent = "" + (grandTotal.toFixed(0)) + " RWF";
      }

      // Checkout functionality
      async function proceedToCheckout() {
        if (shoppingMenu.length === 0) {
          showToast('Your menu is empty', 'error');
          return;
        }

        try {
          // Prepare order data
          const orderData = {
            items: shoppingMenu.map(item => ({
              product_id: item.id,
              product_name: item.name,
              quantity: item.quantity,
              price: item.price,
              seller_id: item.seller_id
            })),
            delivery_info: {
              delivery_address: document.getElementById('delivery-address')?.value || 'Address not provided',
              delivery_phone: document.getElementById('delivery-phone')?.value || '',
              delivery_notes: document.getElementById('delivery-notes')?.value || ''
            },
            totals: {
              products_total: shoppingMenu.reduce((sum, item) => sum + (item.price * item.quantity), 0),
              platform_fee: shoppingMenu.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 0.01,
              packaging_fee: 200,
              delivery_fee: 1500,
              grand_total: calculateGrandTotal()
            }
          };

          // Place order
          const response = await fetch('/api/local-market-orders/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': "Bearer " + (token) + ""
            },
            body: JSON.stringify(orderData)
          });

          const result = await response.json();

          if (result.success) {
            // Store order ID for payment
            localStorage.setItem('currentOrderId', result.order_id);
            
            // Clear menu
            shoppingMenu = [];
            renderMenu();
            
            // Redirect to payment
            window.location.href = "/grocery/local-market-payment.html?order_id=" + (result.order_id) + "";
          } else {
            showToast(result.message || 'Failed to place order', 'error');
          }

        } catch (error) {
          console.error('Checkout error:', error);
          showToast('Failed to place order. Please try again.', 'error');
        }
      }

      function calculateGrandTotal() {
        const productsTotal = shoppingMenu.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const platformFee = productsTotal * 0.01;
        const packagingFee = 200;
        const deliveryFee = 1500;
        return productsTotal + platformFee + packagingFee + deliveryFee;
      }

      // --- EVENT LISTENERS ---
      checkoutBtn.addEventListener('click', () => {
        proceedToCheckout();
      });

      closeModalBtn.addEventListener('click', () => {
        orderConfirmationModal.classList.add('hidden');
      });

      // Add toast notification function
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
        
        if (type === 'success') {
          toast.classList.add('bg-green-500');
        } else if (type === 'error') {
          toast.classList.add('bg-red-500');
        } else {
          toast.classList.add('bg-blue-500');
        }
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
          toast.classList.remove('translate-x-full');
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
          toast.classList.add('translate-x-full');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      // Product Details Modal Functions
      async function viewProductDetails(productId) {
        const modal = document.getElementById('product-details-modal');
        const content = document.getElementById('product-details-content');
        
        modal.classList.remove('hidden');
        
        try {
          const token = localStorage.getItem('authToken') || localStorage.getItem('token');
          const response = await fetch("/api/products/" + (productId) + "", {
            headers: {
              'Authorization': "Bearer " + (token) + ""
            }
          });

          const result = await response.json();
          
          if (result.success) {
            const product = result.product;
            const commission = Math.round((product.price_per_unit - (product.price_per_unit / 1.21)) * 0.15);
            
            content.innerHTML = "
              <div class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                  <div>
                    <img src="" + (product.main_image || '/public/images/placeholder-product.jpg') + "" 
                         alt="" + (product.product_name) + "" class="w-full h-64 object-cover rounded-lg">
                    <div class="grid grid-cols-3 gap-2 mt-4">
                      ${product.additional_images ? product.additional_images.slice(0, 3).map(img => "
                        <img src="${img}" alt="Product image" class="w-full h-20 object-cover rounded-lg cursor-pointer hover:opacity-75">
                      ").join('') : ''}
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <div>
                      <h3 class="text-2xl font-bold text-gray-800">" + (product.product_name) + "</h3>
                      <p class="text-gray-600 mt-2">" + (product.description) + "</p>
                    </div>
                    
                    <div class="bg-green-50 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                        <span class="text-3xl font-bold text-green-600">" + (product.price_per_unit.toLocaleString()) + " RWF</span>
                        <span class="text-gray-500">per " + (product.unit_type) + "</span>
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                      <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600">Category</div>
                        <div class="font-semibold">" + (product.category) + "</div>
                      </div>
                      <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600">Stock</div>
                        <div class="font-semibold">" + (product.stock_quantity) + " " + (product.unit_type) + "</div>
                      </div>
                      <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600">Distance</div>
                        <div class="font-semibold">" + (calculateDistance(product.latitude, product.longitude).toFixed(1)) + " km</div>
                      </div>
                      <div class="bg-blue-50 rounded-lg p-3">
                        <div class="text-blue-600">Share & Earn</div>
                        <div class="font-semibold text-blue-800">" + (commission.toLocaleString()) + " RWF</div>
                      </div>
                    </div>
                    
                    <div class="space-y-3">
                      <div class="flex items-center gap-2">
                        <label class="text-sm font-medium">Quantity:</label>
                        <input type="number" id="modal-qty-" + (product.id) + "" value="1" min="1" max="" + (product.stock_quantity) + "" 
                               class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-2 focus:ring-green-500">
                        <span class="text-sm text-gray-600">" + (product.unit_type) + "</span>
                      </div>
                      
                      <button type="button" onclick="addToMenuFromModal(" + (product.id) + ")" 
                              class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add to Menu
                      </button>
                      
                      <button type="button" onclick="shareProduct(" + (product.id) + ")" 
                              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-xl transition-colors">
                        <i class="fas fa-share-alt mr-2"></i>Share & Earn " + (commission.toLocaleString()) + " RWF
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="border-t border-gray-200 pt-6">
                  <h4 class="text-lg font-semibold text-gray-800 mb-4">Seller Information</h4>
                  <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center gap-4">
                      <img src="" + (product.seller_profile_image || '/public/images/default-avatar.png') + "" 
                           alt="Seller" class="w-12 h-12 rounded-full">
                      <div>
                        <div class="font-semibold">" + (product.seller_name || 'Local Seller') + "</div>
                        <div class="text-sm text-gray-600">" + (product.seller_location || 'Kigali, Rwanda') + "</div>
                        <div class="text-sm text-green-600">
                          <i class="fas fa-star mr-1"></i>
                          " + (product.seller_rating || '4.5') + " (" + (product.seller_reviews || '25') + " reviews)
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            ";
          } else {
            content.innerHTML = '<p class="text-center text-red-500">Failed to load product details</p>';
          }
        } catch (error) {
          console.error('Error loading product details:', error);
          content.innerHTML = '<p class="text-center text-red-500">Error loading product details</p>';
        }
      }

      function closeProductDetailsModal() {
        document.getElementById('product-details-modal').classList.add('hidden');
      }

      function addToMenuFromModal(productId) {
        console.log('addToMenuFromModal called with productId:', productId);
        
        const quantityInput = document.getElementById("modal-qty-" + (productId) + "");
        const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
        const product = allProducts.find(p => p.id == productId); // Use == for type coercion

        console.log('Modal - Found product:', product);

        if (!product) {
          console.error('Modal - Product not found. ProductId:', productId, 'Available IDs:', allProducts.map(p => p.id));
          showToast("Product not found (ID: " + (productId) + ")", 'error');
          return;
        }

        if (quantity <= 0 || quantity > product.stock_quantity) {
          showToast('Invalid quantity selected', 'error');
          return;
        }

        const existingItem = shoppingMenu.find(item => item.id == productId);
        if (existingItem) {
          existingItem.quantity += quantity;
          showToast("Updated " + (product.product_name) + " quantity to " + (existingItem.quantity) + "", 'success');
        } else {
          shoppingMenu.push({ 
            ...product, 
            quantity,
            price: product.price_per_unit || product.price || product.unit_price // Handle different price field names
          });
          showToast("Added " + (quantity) + " " + (product.unit_type || 'unit') + " of " + (product.product_name) + " to menu", 'success');
        }
        
        renderMenu();
        closeProductDetailsModal();
      }

      // Track Location Modal Functions
      let sellerMap = null;

      async function trackOrderLocation(sellerId) {
        const modal = document.getElementById('track-location-modal');
        modal.classList.remove('hidden');
        
        try {
          const token = localStorage.getItem('authToken') || localStorage.getItem('token');
          const response = await fetch("/api/users/" + (sellerId) + "", {
            headers: {
              'Authorization': "Bearer " + (token) + ""
            }
          });

          const result = await response.json();
          
          if (result.success) {
            const seller = result.user;
            displaySellerLocation(seller);
            loadSellerInfo(seller);
          } else {
            showToast('Failed to load seller information', 'error');
          }
        } catch (error) {
          console.error('Error loading seller info:', error);
          showToast('Error loading seller information', 'error');
        }
      }

      function displaySellerLocation(seller) {
        // Initialize map if not already done
        if (!window.L) {
          // Fallback UI when map lib unavailable
          document.getElementById('seller-address').textContent = seller.address || 'Kigali, Rwanda';
          const distance = calculateDistance(seller.latitude || -1.9441, seller.longitude || 30.0619);
          document.getElementById('delivery-distance').textContent = "" + (distance.toFixed(1)) + " km from your location";
          document.getElementById('estimated-delivery').textContent = "" + (Math.round(distance * 2 + 30)) + "-" + (Math.round(distance * 3 + 45)) + " minutes";
          return;
        }

        if (!sellerMap) {
          sellerMap = L.map('seller-map').setView([seller.latitude || -1.9441, seller.longitude || 30.0619], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(sellerMap);
        } else {
          sellerMap.setView([seller.latitude || -1.9441, seller.longitude || 30.0619], 15);
        }

        // Clear existing markers
        sellerMap.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            sellerMap.removeLayer(layer);
          }
        });

        // Add seller marker
        L.marker([seller.latitude || -1.9441, seller.longitude || 30.0619])
          .addTo(sellerMap)
          .bindPopup("<b>" + (seller.full_name || 'Seller') + "</b><br>" + (seller.address || 'Kigali, Rwanda') + "");

        // Add buyer marker (your location)
        L.marker([userLocation.lat, userLocation.lng])
          .addTo(sellerMap)
          .bindPopup('<b>Your Location</b>')
          .setIcon(L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          }));

        // Calculate and display distance
        const distance = calculateDistance(seller.latitude || -1.9441, seller.longitude || 30.0619);
        document.getElementById('seller-address').textContent = seller.address || 'Kigali, Rwanda';
        document.getElementById('delivery-distance').textContent = "" + (distance.toFixed(1)) + " km from your location";
        document.getElementById('estimated-delivery').textContent = "" + (Math.round(distance * 2 + 30)) + "-" + (Math.round(distance * 3 + 45)) + " minutes";
      }

      function loadSellerInfo(seller) {
        const content = document.getElementById('seller-info-content');
        content.innerHTML = "
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <img src="" + (seller.profile_image || '/public/images/default-avatar.png') + "" 
                   alt="Seller" class="w-16 h-16 rounded-full">
              <div>
                <h4 class="text-lg font-semibold">" + (seller.full_name || 'Local Seller') + "</h4>
                <p class="text-gray-600">" + (seller.business_name || 'Local Market Vendor') + "</p>
                <div class="flex items-center gap-1 text-sm text-yellow-500">
                  <i class="fas fa-star"></i>
                  <span>" + (seller.rating || '4.5') + "</span>
                  <span class="text-gray-500">(" + (seller.total_reviews || '25') + " reviews)</span>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-gray-600">Total Products</div>
                <div class="font-semibold">" + (seller.total_products || '15') + "</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-gray-600">Orders Completed</div>
                <div class="font-semibold">" + (seller.completed_orders || '120') + "</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-gray-600">Response Time</div>
                <div class="font-semibold">" + (seller.avg_response_time || '< 1 hour') + "</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-3">
                <div class="text-gray-600">Delivery Success</div>
                <div class="font-semibold">" + (seller.delivery_success_rate || '98') + "%</div>
              </div>
            </div>
            
            <div class="bg-blue-50 rounded-lg p-4">
              <h5 class="font-semibold text-blue-800 mb-2">Delivery Information</h5>
              <div class="text-sm text-blue-700 space-y-1">
                <div><i class="fas fa-truck mr-2"></i>Free delivery for orders above 5,000 RWF</div>
                <div><i class="fas fa-clock mr-2"></i>Usually delivers within 1-2 hours</div>
                <div><i class="fas fa-shield-alt mr-2"></i>100% fresh guarantee</div>
              </div>
            </div>
          </div>
        ";
      }

      function closeTrackLocationModal() {
        document.getElementById('track-location-modal').classList.add('hidden');
      }

      function contactSeller() {
        showToast('Seller contact feature coming soon!', 'info');
      }

      function requestDeliveryUpdate() {
        showToast('Delivery update requested successfully!', 'success');
      }

      // Add missing function definitions that are referenced but not defined
      function openOrdersModal() {
        switchTab('orders');
      }

      function closeOrdersModal() {
        switchTab('browse');
      }

      function openProfileModal() {
        switchTab('profile');
      }

      function closeProfileModal() {
        switchTab('browse');
      }

      function openSupportModal() {
        showToast('Support feature coming soon!', 'info');
      }

      function closeSupportModal() {
        // Implementation for closing support modal
      }

      function saveAsDraft() {
        if (shoppingMenu.length === 0) {
          showToast('Your menu is empty', 'error');
          return;
        }
        
        localStorage.setItem('draftLocalMarketOrder', JSON.stringify(shoppingMenu));
        showToast('Order saved as draft!', 'success');
      }

      function submitPaymentProof() {
        showToast('Payment proof submission feature coming soon!', 'info');
      }

      function updateProfile() {
        const name = document.getElementById('profile-name')?.value;
        const email = document.getElementById('profile-email')?.value;
        const phone = document.getElementById('profile-phone')?.value;
        const address = document.getElementById('profile-address')?.value;

        if (!name || !email) {
          showToast('Name and email are required', 'error');
          return;
        }

        // Here you would typically make an API call to update the profile
        showToast('Profile update feature coming soon!', 'info');
      }

      function submitSupportRequest() {
        showToast('Support request feature coming soon!', 'info');
      }

      // Add to Menu Function (Main product cards)
      function addToMenu(productId) {
        console.log('addToMenu called with productId:', productId);
        console.log('Available products:', allProducts.length);
        
        const quantityInput = document.getElementById("qty-" + (productId) + "");
        const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
        const product = allProducts.find(p => p.id == productId); // Use == for type coercion

        console.log('Found product:', product);

        if (!product) {
          console.error('Product not found. ProductId:', productId, 'Available IDs:', allProducts.map(p => p.id));
          showToast("Product not found (ID: " + (productId) + ")", 'error');
          return;
        }

        if (quantity <= 0 || quantity > product.stock_quantity) {
          showToast('Invalid quantity selected', 'error');
          return;
        }

        const existingItem = shoppingMenu.find(item => item.id == productId);
        if (existingItem) {
          existingItem.quantity += quantity;
          showToast("Updated " + (product.product_name) + " quantity to " + (existingItem.quantity) + "", 'success');
        } else {
          shoppingMenu.push({ 
            ...product, 
            quantity,
            price: product.price_per_unit || product.price || product.unit_price // Handle different price field names
          });
          showToast("Added " + (quantity) + " " + (product.unit_type || 'unit') + " of " + (product.product_name) + " to menu", 'success');
        }
        
        renderMenu();
        
        // Reset quantity input
        if (quantityInput) {
          quantityInput.value = 1;
        }
      }

      // Share Product Function
      async function shareProduct(productId) {
        const product = allProducts.find(p => p.id === productId);
        
        if (!product) {
          showToast('Product not found', 'error');
          return;
        }

        const commission = Math.round((product.price_per_unit - (product.price_per_unit / 1.21)) * 0.15);
        const shareText = "🛒 Check out this amazing product: " + (product.product_name) + "
💰 Price: " + (product.price_per_unit.toLocaleString()) + " RWF per " + (product.unit_type) + "
📍 Distance: " + (calculateDistance(product.latitude, product.longitude).toFixed(1)) + " km away
💵 Earn " + (commission.toLocaleString()) + " RWF commission when someone buys through your link!

Order now: " + (window.location.origin) + "/dist/optimized/grocery/local-market-home-signed.html?product=" + (productId) + "";

        try {
          // Try to use Web Share API if available
          if (navigator.share) {
            await navigator.share({
              title: "" + (product.product_name) + " - ADD Local Market",
              text: shareText,
              url: "" + (window.location.origin) + "/dist/optimized/grocery/local-market-home-signed.html?product=" + (productId) + ""
            });
            showToast('Product shared successfully!', 'success');
          } else {
            // Fallback to clipboard
            await navigator.clipboard.writeText(shareText);
            showToast('Product details copied to clipboard! Share to earn commission.', 'success');
          }

          // Track the share action (you can implement analytics here)
          console.log('Product shared:', productId, 'Commission:', commission);
          
        } catch (error) {
          console.error('Error sharing product:', error);
          
          // Final fallback - show share modal
          showShareModal(product, shareText, commission);
        }
      }

      // Show Share Modal (fallback)
      function showShareModal(product, shareText, commission) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50';
        modal.innerHTML = "
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="text-center mb-4">
              <h3 class="text-xl font-bold text-gray-800">Share & Earn " + (commission.toLocaleString()) + " RWF</h3>
              <p class="text-gray-600 mt-2">Share this product to earn commission!</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
              <textarea readonly class="w-full h-32 text-sm border-none bg-transparent resize-none focus:outline-none">" + (shareText) + "</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
              <button onclick="copyToClipboard('" + (shareText.replace(/'/g, "\\'")) + "'); this.closest('.fixed').remove();" 
                      class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                <i class="fas fa-copy mr-2"></i>Copy Text
              </button>
              <button onclick="shareToWhatsApp('" + (encodeURIComponent(shareText)) + "'); this.closest('.fixed').remove();" 
                      class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                <i class="fab fa-whatsapp mr-2"></i>WhatsApp
              </button>
            </div>
            
            <button onclick="this.closest('.fixed').remove();" 
                    class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 rounded-lg transition-colors">
              Close
            </button>
          </div>
        ";
        
        document.body.appendChild(modal);
      }

      // Helper functions for sharing
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('Copied to clipboard!', 'success');
        }).catch(() => {
          showToast('Failed to copy to clipboard', 'error');
        });
      }

      function shareToWhatsApp(text) {
        window.open("https://wa.me/?text=" + (text) + "", '_blank');
        showToast('Opening WhatsApp...', 'info');
      }

      // Handle Checkout Function
      function handleCheckout() {
        if (shoppingMenu.length === 0) {
          showToast('Your menu is empty. Add some products first!', 'error');
          return;
        }

        // Calculate totals
        const subtotal = shoppingMenu.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const deliveryFee = 500; // Fixed delivery fee
        const total = subtotal + deliveryFee;

        // Open checkout modal
        openCheckoutModal(subtotal, deliveryFee, total);
      }

      // Open Checkout Modal
      function openCheckoutModal(subtotal, deliveryFee, total) {
        const modal = document.getElementById('checkout-modal');
        const content = document.getElementById('checkout-content');
        
        content.innerHTML = "
          <div class="space-y-6">
            <!-- Order Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h3 class="font-semibold text-gray-800 mb-3">Order Summary</h3>
              <div class="space-y-2">
                ${shoppingMenu.map(item => "
                  <div class="flex justify-between text-sm">
                    <span>${item.product_name} x${item.quantity}</span>
                    <span>${(item.price * item.quantity).toFixed(2)} RWF</span>
                  </div>
                ").join('')}
                <hr class="my-2">
                <div class="flex justify-between text-sm">
                  <span>Subtotal:</span>
                  <span>" + (subtotal.toFixed(2)) + " RWF</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>Delivery Fee:</span>
                  <span>" + (deliveryFee.toFixed(2)) + " RWF</span>
                </div>
                <div class="flex justify-between font-semibold text-lg border-t pt-2">
                  <span>Total:</span>
                  <span>" + (total.toFixed(2)) + " RWF</span>
                </div>
              </div>
            </div>

            <!-- Delivery Information -->
            <div>
              <h3 class="font-semibold text-gray-800 mb-3">Delivery Information</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                  <input type="text" id="delivery-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                  <input type="tel" id="delivery-phone" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                  <textarea id="delivery-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter your full delivery address..." required></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Notes (Optional)</label>
                  <textarea id="delivery-notes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Any special delivery instructions..."></textarea>
                </div>
              </div>
            </div>

            <!-- Payment Method -->
            <div>
              <h3 class="font-semibold text-gray-800 mb-3">Payment Method</h3>
              <div class="space-y-3">
                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" name="payment-method" value="mobile_money" class="mr-3" checked>
                  <div class="flex items-center gap-3">
                    <i class="fas fa-mobile-alt text-green-600"></i>
                    <div>
                      <p class="font-medium">Mobile Money</p>
                      <p class="text-sm text-gray-600">Pay with MTN Mobile Money or Airtel Money</p>
                    </div>
                  </div>
                </label>
                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" name="payment-method" value="cash" class="mr-3">
                  <div class="flex items-center gap-3">
                    <i class="fas fa-money-bill-wave text-green-600"></i>
                    <div>
                      <p class="font-medium">Cash on Delivery</p>
                      <p class="text-sm text-gray-600">Pay when your order arrives</p>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeCheckoutModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 rounded-xl transition-colors">
                Cancel
              </button>
              <button type="button" onclick="proceedToPayment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                Place Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Proof Modal -->
    <div id="payment-proof-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-backdrop fixed inset-0" onclick="closePaymentProofModal()"></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-gray-800">Submit Payment Proof</h2>
              <button onclick="closePaymentProofModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div id="payment-proof-content">
              <div class="space-y-6">
                <div class="text-center">
                  <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-receipt text-2xl text-blue-600"></i>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-2">Upload Payment Receipt</h3>
                  <p class="text-gray-600">Please upload your payment receipt to complete the order</p>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Receipt</label>
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                      <input type="file" id="payment-proof-file" accept="image/*,.pdf" onchange="handlePaymentProofUpload(event)" class="hidden">
                      <label for="payment-proof-file" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">Click to upload or drag and drop</p>
                        <p class="text-xs text-gray-500 mt-1">PNG, JPG, PDF up to 5MB</p>
                      </label>
                    </div>
                    <div id="upload-preview" class="mt-3 hidden">
                      <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <img id="preview-image" src="" alt="Preview" class="w-12 h-12 object-cover rounded">
                        <div>
                          <p id="file-name" class="text-sm font-medium text-gray-800"></p>
                          <p class="text-xs text-green-600">File ready to upload</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Reference (Optional)</label>
                    <input type="text" id="transaction-ref" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter transaction reference">
                  </div>

                  <div class="flex gap-3">
                    <button type="button" onclick="saveAsDraft()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 rounded-xl transition-colors">
                      Save as Draft
                    </button>
                    <button type="button" onclick="submitPaymentProof()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                      Submit Order
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Handle Payment Proof Upload
      function handlePaymentProofUpload(event) {
        const file = event.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            if (typeof showNotification === 'function') {
              showNotification('File size must be less than 5MB', 'error');
            }
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('upload-area').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('hidden');
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('file-name').textContent = file.name;
          };
          reader.readAsDataURL(file);
        }
      }

      // Proceed to Payment
      function proceedToPayment() {
        const name = document.getElementById('delivery-name').value.trim();
        const phone = document.getElementById('delivery-phone').value.trim();
        const address = document.getElementById('delivery-address').value.trim();
        const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

        if (!name || !phone || !address) {
          if (typeof showNotification === 'function') {
            showNotification('Please fill in all required delivery information', 'error');
          }
          return;
        }

        const orderData = {
          items: window.shoppingMenu || [],
          delivery: { name, phone, address },
          payment_method: paymentMethod,
          total: (window.shoppingMenu || []).reduce((sum, item) => sum + (item.price * item.quantity), 0)
        };

        // Store order data for payment proof
        localStorage.setItem('draftOrder', JSON.stringify(orderData));
        
        if (typeof closeCheckoutModal === 'function') {
          closeCheckoutModal();
        }
        if (typeof openPaymentProofModal === 'function') {
          openPaymentProofModal(orderData);
        }
      }

      // Close Payment Proof Modal
      function closePaymentProofModal() {
        const modal = document.getElementById('payment-proof-modal');
        if (modal) {
          modal.classList.add('hidden');
        }
      }

      // Expose functions globally
      window.handlePaymentProofUpload = handlePaymentProofUpload;
      window.proceedToPayment = proceedToPayment;
      window.closePaymentProofModal = closePaymentProofModal;

    
      // ===== PRODUCTS DISPLAY SYSTEM =====
      
      // Demo products data
      const demoProducts = [
        { id: 1, product_name: "Fresh Tomatoes", description: "Locally grown fresh tomatoes, perfect for cooking and salads", price_per_unit: 500, unit_type: "kg", stock_quantity: 25, main_image: "/public/images/products/tomatoes.jpg", category: "vegetables" },
        { id: 2, product_name: "Organic Bananas", description: "Sweet and ripe organic bananas from local farms", price_per_unit: 800, unit_type: "bunch", stock_quantity: 15, main_image: "/public/images/products/bananas.jpg", category: "fruits" },
        { id: 3, product_name: "Fresh Milk", description: "Pure fresh milk from local dairy farms", price_per_unit: 1200, unit_type: "liter", stock_quantity: 30, main_image: "/public/images/products/milk.jpg", category: "dairy" },
        { id: 4, product_name: "White Rice", description: "Premium quality white rice, perfect for daily meals", price_per_unit: 1500, unit_type: "kg", stock_quantity: 50, main_image: "/public/images/products/rice.jpg", category: "grains" },
        { id: 5, product_name: "Fresh Bread", description: "Freshly baked bread from local bakery", price_per_unit: 300, unit_type: "loaf", stock_quantity: 20, main_image: "/public/images/products/bread.jpg", category: "bakery" },
        { id: 6, product_name: "Chicken Eggs", description: "Fresh chicken eggs from free-range chickens", price_per_unit: 2000, unit_type: "dozen", stock_quantity: 40, main_image: "/public/images/products/eggs.jpg", category: "dairy" }
      ];

      // Initialize global variables
      let allProducts = demoProducts;
      let filteredProducts = [...demoProducts];
      if (!window.shoppingMenu) window.shoppingMenu = [];

      // Display products function
      function displayProducts() {
        console.log('🎨 Displaying products...');
        
        const productListings = document.getElementById('product-listings');
        const productsLoading = document.getElementById('products-loading');
        const productsCount = document.getElementById('products-count');
        
        if (!productListings) {
          console.error('❌ Product listings container not found');
          return;
        }

        // Hide loading skeleton and show products container
        if (productsLoading) {
          productsLoading.classList.add('hidden');
          console.log('🔧 Hidden loading skeleton');
        }
        
        productListings.classList.remove('hidden');
        console.log('🔧 Made products container visible');
        
        // Update products count
        if (productsCount) {
          productsCount.textContent = "Showing " + filteredProducts.length + " products";
        }

        // Generate product cards HTML
        const productsHTML = filteredProducts.map(product => "
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 fade-in">
            <div class="relative">
              <img src="${product.main_image}" 
                   alt="${product.product_name}" 
                   class="w-full h-48 object-cover"
                   onerror="this.src='/public/images/placeholder-product.jpg'; this.onerror=null;">
              <div class="absolute top-4 right-4">
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                  In Stock
                </span>
              </div>
              ${product.stock_quantity <= 5 ? "
                <div class="absolute top-4 left-4">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                    Only " + (product.stock_quantity) + " left
                  </span>
                </div>
              " : ''}
            </div>
            
            <div class="p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-2">${product.product_name}</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description}</p>
              
              <div class="flex items-center justify-between mb-4">
                <div>
                  <span class="text-xl font-bold text-green-600">${product.price_per_unit.toLocaleString()} RWF</span>
                  <span class="text-gray-500 text-sm">/ ${product.unit_type}</span>
                </div>
                <span class="text-sm text-gray-500">${product.stock_quantity} available</span>
              </div>
              
              <div class="flex items-center gap-2">
                <div class="flex items-center border border-gray-300 rounded-lg">
                  <button onclick="changeQuantity(${product.id}, -1)" 
                          class="p-2 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-minus text-sm"></i>
                  </button>
                  <input type="number" 
                         id="qty-${product.id}" 
                         value="1" 
                         min="1" 
                         max="${product.stock_quantity}" 
                         class="w-16 text-center border-0 focus:ring-0 text-sm" 
                         readonly>
                  <button onclick="changeQuantity(${product.id}, 1)" 
                          class="p-2 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-plus text-sm"></i>
                  </button>
                </div>
                <button onclick="addToCart(${product.id})" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                  <i class="fas fa-cart-plus mr-2"></i>
                  Add to Cart
                </button>
              </div>
            </div>
          </div>
        `).join('');

        // Insert the HTML
        productListings.innerHTML = productsHTML;
        
        console.log("✅ Successfully displayed " + (filteredProducts.length) + " products");
      }

      // Change quantity function
      function changeQuantity(productId, change) {
        const input = document.getElementById("qty-" + (productId) + "");
        if (input) {
          const currentValue = parseInt(input.value) || 1;
          const maxValue = parseInt(input.max) || 99;
          const newValue = Math.max(1, Math.min(maxValue, currentValue + change));
          input.value = newValue;
          console.log("🔢 Changed quantity for product " + (productId) + " to " + (newValue) + "");
        }
      }

      // Add to cart function
      function addToCart(productId) {
        console.log("🛒 Adding product " + (productId) + " to cart...");
        
        const product = allProducts.find(p => p.id === productId);
        const quantityInput = document.getElementById("qty-" + (productId) + "");
        
        if (!product) {
          console.error("❌ Product " + (productId) + " not found");
          return;
        }
        
        if (!quantityInput) {
          console.error("❌ Quantity input for product " + (productId) + " not found");
          return;
        }

        const quantity = parseInt(quantityInput.value) || 1;
        
        // Check if product already exists in cart
        const existingItemIndex = window.shoppingMenu.findIndex(item => item.id === productId);
        
        if (existingItemIndex !== -1) {
          // Update existing item
          window.shoppingMenu[existingItemIndex].quantity += quantity;
          console.log("📦 Updated existing cart item: " + (product.product_name) + "");
        } else {
          // Add new item to cart
          window.shoppingMenu.push({
            id: product.id,
            name: product.product_name,
            price: product.price_per_unit,
            unit: product.unit_type,
            quantity: quantity,
            image: product.main_image,
            max_quantity: product.stock_quantity
          });
          console.log("📦 Added new item to cart: " + (product.product_name) + "");
        }

        // Reset quantity input to 1
        quantityInput.value = 1;
        
        // Update cart badge
        updateCartBadge();
        
        // Show success notification
        showNotification("Added " + (product.product_name) + " to cart!", 'success');
        
        console.log("✅ Successfully added " + (product.product_name) + " to cart (qty: " + (quantity) + ")");
      }

      // Update cart badge
      function updateCartBadge() {
        const cartBadge = document.getElementById('tab-cart-badge');
        const totalItems = window.shoppingMenu.reduce((sum, item) => sum + item.quantity, 0);
        
        if (cartBadge) {
          if (totalItems > 0) {
            cartBadge.textContent = totalItems;
            cartBadge.classList.remove('hidden');
          } else {
            cartBadge.classList.add('hidden');
          }
        }
        
        console.log("🛒 Cart badge updated: " + (totalItems) + " items");
      }

      // Show notification function
      function showNotification(message, type = 'info') {
        // Try to use existing notification system first
        if (typeof window.showNotification === 'function') {
          window.showNotification(message, type);
          return;
        }
        
        // Fallback notification system
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        
        notification.className = "fixed top-4 right-4 " + (bgColor) + " text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300";
        notification.innerHTML = "
          <div class="flex items-center gap-2">
            <i class="fas fa-" + (type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle') + ""></i>
            <span>" + (message) + "</span>
          </div>
        ";
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        
        // Animate out and remove
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Load products function
      async function loadProducts() {
        console.log('🔄 Loading products...');
        
        try {
          // Try to load from API if auth token exists
          if (typeof getAuthToken === 'function') {
            const token = getAuthToken();
            if (token) {
              const response = await fetch('/api/products/grocery', {
                headers: {
                  'Authorization': "Bearer " + (token) + "",
                  'Content-Type': 'application/json'
                }
              });

              if (response.ok) {
                const data = await response.json();
                if (data.products && data.products.length > 0) {
                  allProducts = data.products;
                  console.log("✅ Loaded " + (allProducts.length) + " products from API");
                } else {
                  throw new Error('No products in API response');
                }
              } else {
                throw new Error("API responded with status " + (response.status) + "");
              }
            } else {
              throw new Error('No authentication token');
            }
          } else {
            throw new Error('getAuthToken function not available');
          }
        } catch (error) {
          console.log("⚠️ API not available (" + (error.message) + "), using demo products");
          allProducts = demoProducts;
        }

        // Ensure we have products to display
        if (!allProducts || allProducts.length === 0) {
          console.log('🔧 No products loaded, using demo products as fallback');
          allProducts = demoProducts;
        }

        // Set filtered products
        filteredProducts = [...allProducts];
        
        // Display the products
        displayProducts();
        
        // Update cart badge
        updateCartBadge();
        
        console.log("🎉 Products loading completed: " + (allProducts.length) + " products available");
      }

      // Force products display (emergency function)
      function forceDisplayProducts() {
        console.log('🚨 Force displaying products...');
        
        // Ensure we have demo products
        if (!allProducts || allProducts.length === 0) {
          allProducts = demoProducts;
          filteredProducts = [...demoProducts];
        }
        
        // Force display
        displayProducts();
        
        console.log('🚨 Force display completed');
      }

      // Initialize products system
      function initializeProductsSystem() {
        console.log('🚀 Initializing products system...');
        
        // Set up global variables
        window.allProducts = allProducts;
        window.filteredProducts = filteredProducts;
        window.demoProducts = demoProducts;
        
        // Expose functions globally
        window.displayProducts = displayProducts;
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.loadProducts = loadProducts;
        window.updateCartBadge = updateCartBadge;
        window.forceDisplayProducts = forceDisplayProducts;
        
        // Load products
        loadProducts();
        
        console.log('✅ Products system initialized');
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeProductsSystem);
      } else {
        initializeProductsSystem();
      }

      // Backup initialization on window load
      window.addEventListener('load', function() {
        setTimeout(() => {
          if (!window.allProducts || window.allProducts.length === 0) {
            console.log('🔄 Backup initialization triggered');
            initializeProductsSystem();
          }
          
          // Force display if products container is still hidden
          const productListings = document.getElementById('product-listings');
          if (productListings && productListings.classList.contains('hidden')) {
            console.log('🔧 Products container still hidden, forcing display...');
            forceDisplayProducts();
          }
        }, 1000);
      });

      // Debug function to check products status
      window.debugProducts = function() {
        console.log('🔍 Products Debug Info:');
        console.log('- allProducts:', window.allProducts);
        console.log('- filteredProducts:', window.filteredProducts);
        console.log('- shoppingMenu:', window.shoppingMenu);
        
        const container = document.getElementById('product-listings');
        console.log('- product-listings container:', container);
        console.log('- container hidden:', container ? container.classList.contains('hidden') : 'N/A');
        console.log('- container children:', container ? container.children.length : 'N/A');
        
        const loading = document.getElementById('products-loading');
        console.log('- loading skeleton hidden:', loading ? loading.classList.contains('hidden') : 'N/A');
      };

      console.log('📦 Products display system loaded and ready!');
    </script>
 
  </body>
</html>
                </label>
                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                  <input type="radio" name="payment-method" value="cash" class="mr-3">
                  <div class="flex items-center gap-3">
                    <i class="fas fa-money-bill-wave text-green-600"></i>
                    <div>
                      <p class="font-medium">Cash on Delivery</p>
                      <p class="text-sm text-gray-600">Pay when your order arrives</p>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeCheckoutModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 rounded-xl transition-colors">
                Cancel
              </button>
              <button type="button" onclick="proceedToPayment()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-xl transition-colors">
                Place Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== PRODUCTS DISPLAY SYSTEM =====
      
      // Demo products data
      const demoProducts = [
        { id: 1, product_name: "Fresh Tomatoes", description: "Locally grown fresh tomatoes, perfect for cooking and salads", price_per_unit: 500, unit_type: "kg", stock_quantity: 25, main_image: "/public/images/products/tomatoes.jpg", category: "vegetables" },
        { id: 2, product_name: "Organic Bananas", description: "Sweet and ripe organic bananas from local farms", price_per_unit: 800, unit_type: "bunch", stock_quantity: 15, main_image: "/public/images/products/bananas.jpg", category: "fruits" },
        { id: 3, product_name: "Fresh Milk", description: "Pure fresh milk from local dairy farms", price_per_unit: 1200, unit_type: "liter", stock_quantity: 30, main_image: "/public/images/products/milk.jpg", category: "dairy" },
        { id: 4, product_name: "White Rice", description: "Premium quality white rice, perfect for daily meals", price_per_unit: 1500, unit_type: "kg", stock_quantity: 50, main_image: "/public/images/products/rice.jpg", category: "grains" },
        { id: 5, product_name: "Fresh Bread", description: "Freshly baked bread from local bakery", price_per_unit: 300, unit_type: "loaf", stock_quantity: 20, main_image: "/public/images/products/bread.jpg", category: "bakery" },
        { id: 6, product_name: "Chicken Eggs", description: "Fresh chicken eggs from free-range chickens", price_per_unit: 2000, unit_type: "dozen", stock_quantity: 40, main_image: "/public/images/products/eggs.jpg", category: "dairy" }
      ];

      // Initialize global variables
      let allProducts = demoProducts;
      let filteredProducts = [...demoProducts];
      if (!window.shoppingMenu) window.shoppingMenu = [];

      // Display products function
      function displayProducts() {
        console.log('🎨 Displaying products...');
        
        const productListings = document.getElementById('product-listings');
        const productsLoading = document.getElementById('products-loading');
        const productsCount = document.getElementById('products-count');
        
        if (!productListings) {
          console.error('❌ Product listings container not found');
          return;
        }

        // Hide loading skeleton and show products container
        if (productsLoading) {
          productsLoading.classList.add('hidden');
          console.log('🔧 Hidden loading skeleton');
        }
        
        productListings.classList.remove('hidden');
        console.log('🔧 Made products container visible');
        
        // Update products count
        if (productsCount) {
          productsCount.textContent = "Showing " + filteredProducts.length + " products";
        }

        // Generate product cards HTML using string concatenation (no template literals)
        const productsHTML = filteredProducts.map(function(product) {
          return '<div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 fade-in">' +
            '<div class="relative">' +
              '<img src="' + product.main_image + '" alt="' + product.product_name + '" class="w-full h-48 object-cover" onerror="this.src=\'/public/images/placeholder-product.jpg\'; this.onerror=null;">' +
              '<div class="absolute top-4 right-4">' +
                '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">In Stock</span>' +
              '</div>' +
              (product.stock_quantity <= 5 ? 
                '<div class="absolute top-4 left-4">' +
                  '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">Only ' + product.stock_quantity + ' left</span>' +
                '</div>' : '') +
            '</div>' +
            '<div class="p-6">' +
              '<h3 class="text-lg font-bold text-gray-800 mb-2">' + product.product_name + '</h3>' +
              '<p class="text-sm text-gray-600 mb-3 line-clamp-2">' + product.description + '</p>' +
              '<div class="flex items-center justify-between mb-4">' +
                '<div>' +
                  '<span class="text-xl font-bold text-green-600">' + product.price_per_unit.toLocaleString() + ' RWF</span>' +
                  '<span class="text-gray-500 text-sm">/ ' + product.unit_type + '</span>' +
                '</div>' +
                '<span class="text-sm text-gray-500">' + product.stock_quantity + ' available</span>' +
              '</div>' +
              '<div class="flex items-center gap-2">' +
                '<div class="flex items-center border border-gray-300 rounded-lg">' +
                  '<button onclick="changeQuantity(' + product.id + ', -1)" class="p-2 hover:bg-gray-100 transition-colors">' +
                    '<i class="fas fa-minus text-sm"></i>' +
                  '</button>' +
                  '<input type="number" id="qty-' + product.id + '" value="1" min="1" max="' + product.stock_quantity + '" class="w-16 text-center border-0 focus:ring-0 text-sm" readonly>' +
                  '<button onclick="changeQuantity(' + product.id + ', 1)" class="p-2 hover:bg-gray-100 transition-colors">' +
                    '<i class="fas fa-plus text-sm"></i>' +
                  '</button>' +
                '</div>' +
                '<button onclick="addToCart(' + product.id + ')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">' +
                  '<i class="fas fa-cart-plus mr-2"></i>Add to Cart' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        // Insert the HTML
        productListings.innerHTML = productsHTML;
        
        console.log('✅ Successfully displayed ' + filteredProducts.length + ' products');
      }

      // Change quantity function
      function changeQuantity(productId, change) {
        const input = document.getElementById('qty-' + productId);
        if (input) {
          const currentValue = parseInt(input.value) || 1;
          const maxValue = parseInt(input.max) || 99;
          const newValue = Math.max(1, Math.min(maxValue, currentValue + change));
          input.value = newValue;
          console.log('🔢 Changed quantity for product ' + productId + ' to ' + newValue);
        }
      }

      // Add to cart function
      function addToCart(productId) {
        console.log('🛒 Adding product ' + productId + ' to cart...');
        
        const product = allProducts.find(function(p) { return p.id === productId; });
        const quantityInput = document.getElementById('qty-' + productId);
        
        if (!product) {
          console.error('❌ Product ' + productId + ' not found');
          return;
        }
        
        if (!quantityInput) {
          console.error('❌ Quantity input for product ' + productId + ' not found');
          return;
        }

        const quantity = parseInt(quantityInput.value) || 1;
        
        // Check if product already exists in cart
        const existingItemIndex = window.shoppingMenu.findIndex(function(item) { return item.id === productId; });
        
        if (existingItemIndex !== -1) {
          // Update existing item
          window.shoppingMenu[existingItemIndex].quantity += quantity;
          console.log('📦 Updated existing cart item: ' + product.product_name);
        } else {
          // Add new item to cart
          window.shoppingMenu.push({
            id: product.id,
            name: product.product_name,
            price: product.price_per_unit,
            unit: product.unit_type,
            quantity: quantity,
            image: product.main_image,
            max_quantity: product.stock_quantity
          });
          console.log('📦 Added new item to cart: ' + product.product_name);
        }

        // Reset quantity input to 1
        quantityInput.value = 1;
        
        // Update cart badge
        updateCartBadge();
        
        // Show success notification
        showNotification('Added ' + product.product_name + ' to cart!', 'success');
        
        console.log('✅ Successfully added ' + product.product_name + ' to cart (qty: ' + quantity + ')');
      }

      // Update cart badge
      function updateCartBadge() {
        const cartBadge = document.getElementById('tab-cart-badge');
        const totalItems = window.shoppingMenu.reduce(function(sum, item) { return sum + item.quantity; }, 0);
        
        if (cartBadge) {
          if (totalItems > 0) {
            cartBadge.textContent = totalItems;
            cartBadge.classList.remove('hidden');
          } else {
            cartBadge.classList.add('hidden');
          }
        }
        
        console.log('🛒 Cart badge updated: ' + totalItems + ' items');
      }

      // Show notification function
      function showNotification(message, type) {
        type = type || 'info';
        
        // Try to use existing notification system first
        if (typeof window.showNotification === 'function') {
          window.showNotification(message, type);
          return;
        }
        
        // Fallback notification system
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        
        notification.className = 'fixed top-4 right-4 ' + bgColor + ' text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
        notification.innerHTML = '<div class="flex items-center gap-2">' +
          '<i class="fas fa-' + (type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle') + '"></i>' +
          '<span>' + message + '</span>' +
        '</div>';
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(function() { notification.classList.remove('translate-x-full'); }, 100);
        
        // Animate out and remove
        setTimeout(function() {
          notification.classList.add('translate-x-full');
          setTimeout(function() { notification.remove(); }, 300);
        }, 3000);
      }

      // Load products function
      function loadProducts() {
        console.log('🔄 Loading products...');
        
        // For now, always use demo products to ensure functionality
        allProducts = demoProducts;
        filteredProducts = [...allProducts];
        
        // Display the products
        displayProducts();
        
        // Update cart badge
        updateCartBadge();
        
        console.log('🎉 Products loading completed: ' + allProducts.length + ' products available');
      }

      // Force products display (emergency function)
      function forceDisplayProducts() {
        console.log('🚨 Force displaying products...');
        
        // Ensure we have demo products
        if (!allProducts || allProducts.length === 0) {
          allProducts = demoProducts;
          filteredProducts = [...demoProducts];
        }
        
        // Force display
        displayProducts();
        
        console.log('🚨 Force display completed');
      }

      // Initialize products system
      function initializeProductsSystem() {
        console.log('🚀 Initializing products system...');
        
        // Set up global variables
        window.allProducts = allProducts;
        window.filteredProducts = filteredProducts;
        window.demoProducts = demoProducts;
        
        // Expose functions globally
        window.displayProducts = displayProducts;
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.loadProducts = loadProducts;
        window.updateCartBadge = updateCartBadge;
        window.forceDisplayProducts = forceDisplayProducts;
        
        // Load products
        loadProducts();
        
        console.log('✅ Products system initialized');
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeProductsSystem);
      } else {
        initializeProductsSystem();
      }

      // Backup initialization on window load
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (!window.allProducts || window.allProducts.length === 0) {
            console.log('🔄 Backup initialization triggered');
            initializeProductsSystem();
          }
          
          // Force display if products container is still hidden
          const productListings = document.getElementById('product-listings');
          if (productListings && productListings.classList.contains('hidden')) {
            console.log('🔧 Products container still hidden, forcing display...');
            forceDisplayProducts();
          }
        }, 1000);
      });

      // Debug function to check products status
      window.debugProducts = function() {
        console.log('🔍 Products Debug Info:');
        console.log('- allProducts:', window.allProducts);
        console.log('- filteredProducts:', window.filteredProducts);
        console.log('- shoppingMenu:', window.shoppingMenu);
        
        const container = document.getElementById('product-listings');
        console.log('- product-listings container:', container);
        console.log('- container hidden:', container ? container.classList.contains('hidden') : 'N/A');
        console.log('- container children:', container ? container.children.length : 'N/A');
        
        const loading = document.getElementById('products-loading');
        console.log('- loading skeleton hidden:', loading ? loading.classList.contains('hidden') : 'N/A');
      };

      console.log('📦 Products display system loaded and ready!');

    </script>

  </body>
</html>